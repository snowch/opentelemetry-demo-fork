<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observability Diagnostic Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.6/dist/vis-network.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: rgba(26, 26, 36, 0.8);
            --border-color: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(0, 217, 255, 0.2);
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --gradient-primary: linear-gradient(135deg, #00d9ff 0%, #7c3aed 100%);
            --gradient-bg: linear-gradient(180deg, #0a0a0f 0%, #12121a 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 30px rgba(0, 217, 255, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-bg);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 18px;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-section {
            margin-bottom: 28px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--text-muted);
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--accent-primary);
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(0, 217, 255, 0.1);
        }

        .status-card {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .status-card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-glow);
        }

        .status-card-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .service-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            margin: -2px -8px;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .service-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .service-name {
            color: var(--text-primary);
            font-weight: 500;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .status-healthy {
            background: rgba(16, 185, 129, 0.15);
            color: var(--accent-success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        .status-warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* Alerts Styling */
        .alerts-badge {
            background: var(--accent-error);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alerts-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .alert-item:hover {
            transform: translateX(2px);
        }

        .alert-critical {
            background: rgba(239, 68, 68, 0.12);
            border-left: 3px solid var(--accent-error);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.12);
            border-left: 3px solid var(--accent-warning);
        }

        .alert-info {
            background: rgba(0, 217, 255, 0.12);
            border-left: 3px solid var(--accent-primary);
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .alert-severity {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .alert-severity.critical { color: var(--accent-error); }
        .alert-severity.warning { color: var(--accent-warning); }
        .alert-severity.info { color: var(--accent-primary); }

        .alert-category {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
            margin-left: 6px;
        }

        .alert-category.root-cause {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }

        .alert-category.symptom {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }

        .alert-time {
            font-size: 10px;
            color: var(--text-muted);
        }

        .alert-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .alert-description {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .alert-root-cause {
            font-size: 11px;
            color: var(--accent-primary);
            line-height: 1.4;
            font-weight: 500;
        }

        .alert-summary {
            display: flex;
            gap: 12px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .alert-summary-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .alert-summary-count {
            font-weight: 600;
        }

        .alert-summary-count.critical { color: var(--accent-error); }
        .alert-summary-count.warning { color: var(--accent-warning); }

        /* Activity log styles */
        .activity-list {
            max-height: 180px;
            overflow-y: auto;
        }

        .activity-event {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            font-size: 11px;
        }

        .activity-icon {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .activity-icon.created {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }

        .activity-icon.auto_resolved {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-success);
        }

        .activity-icon.resolved {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-text {
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .activity-text strong {
            color: var(--text-primary);
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 10px;
            margin-top: 2px;
        }

        /* Combined alerts styles */
        .combined-alerts-list .alert-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid var(--border-color);
        }
        .combined-alerts-list .alert-item:hover {
            transform: translateX(2px);
        }
        .combined-alerts-list .alert-item.resolved {
            opacity: 0.5;
        }
        .combined-alerts-list .alert-item.alert-critical {
            background: rgba(239, 68, 68, 0.12);
            border-left-color: var(--accent-error);
        }
        .combined-alerts-list .alert-item.alert-warning {
            background: rgba(245, 158, 11, 0.12);
            border-left-color: var(--accent-warning);
        }
        .combined-alerts-list .alert-item.alert-info {
            background: rgba(0, 217, 255, 0.12);
            border-left-color: var(--accent-primary);
        }
        .combined-alerts-list .alert-item.alert-forecast {
            background: rgba(139, 92, 246, 0.10);
            border-left-color: #a78bfa;
        }
        .alert-type-badge {
            display: inline-block;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 1px 5px;
            border-radius: 3px;
            margin-left: 6px;
        }
        .alert-type-badge.severity-critical { background: rgba(239, 68, 68, 0.2); color: var(--accent-error); }
        .alert-type-badge.severity-warning { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        .alert-type-badge.severity-info { background: rgba(0, 217, 255, 0.2); color: var(--accent-primary); }
        .alert-type-badge.badge-forecast { background: rgba(139, 92, 246, 0.2); color: #a78bfa; }
        .alert-type-badge.badge-resolved { background: rgba(34, 197, 94, 0.2); color: var(--accent-success); }
        .alert-type-badge.badge-activity { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        /* Background jobs styles */
        .job-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border-left: 3px solid var(--accent-success);
        }
        .job-item.job-stale {
            border-left-color: var(--accent-warning);
        }
        .job-item.job-error {
            border-left-color: var(--accent-error);
        }
        .job-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--accent-success);
        }
        .job-item.job-stale .job-indicator { background: var(--accent-warning); }
        .job-item.job-error .job-indicator { background: var(--accent-error); }
        .job-info {
            flex: 1;
            min-width: 0;
        }
        .job-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .job-details {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 1px;
        }

        .error-item {
            padding: 12px;
            background: rgba(239, 68, 68, 0.08);
            border-left: 3px solid var(--accent-error);
            margin-bottom: 8px;
            border-radius: 0 10px 10px 0;
            transition: all 0.2s;
        }

        .error-item:hover {
            background: rgba(239, 68, 68, 0.12);
        }

        .error-service {
            color: var(--accent-error);
            font-weight: 600;
            font-size: 12px;
        }
        .error-span {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 2px;
        }

        .last-updated {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: var(--bg-primary);
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            padding: 16px 28px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions button {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .header-actions button:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Chat Container */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 28px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            max-width: 80%;
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            margin-left: auto;
            align-self: flex-end;
        }

        .message-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message.user .message-label { text-align: right; }

        .message-content {
            padding: 18px 22px;
            border-radius: 18px;
            line-height: 1.6;
            font-size: 14px;
        }

        .message.user .message-content {
            background: var(--gradient-primary);
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
        }

        /* Charts */
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            max-width: 650px;
        }

        .chart-container canvas {
            max-height: 280px;
        }

        /* Query Results */
        .query-block {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin: 12px 0;
            overflow: hidden;
        }

        .query-header {
            background: var(--bg-tertiary);
            padding: 12px 16px;
            font-size: 12px;
            font-weight: 500;
            color: var(--accent-primary);
            display: flex;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .query-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .query-sql {
            padding: 16px;
            background: var(--bg-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            overflow-x: auto;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        .query-results { padding: 16px; }

        .query-results table {
            width: 100%;
            border-collapse: collapse;
        }

        .query-results th {
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .query-results td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .query-results tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Input Area */
        .input-area {
            padding: 16px 28px 28px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
        }

        .input-options {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .filter-bar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            flex-wrap: wrap;
        }

        .filter-bar input[type="text"],
        .filter-bar input[type="number"] {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: inherit;
            min-width: 150px;
        }

        .filter-bar input[type="number"] {
            min-width: 100px;
        }

        .filter-bar input:hover {
            border-color: var(--accent-primary);
        }

        .filter-bar input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
        }

        .filter-bar select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .filter-bar select:hover {
            border-color: var(--accent-primary);
        }

        .filter-bar select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
        }

        .time-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-selector label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .time-selector select {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
        }

        .time-selector select:hover {
            border-color: var(--accent-primary);
        }

        .time-selector select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
        }

        .input-container {
            display: flex;
            gap: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 8px;
            transition: all 0.3s;
        }

        .input-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .input-container textarea {
            flex: 1;
            background: transparent;
            border: none;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 14px;
            resize: none;
            height: 48px;
            font-family: inherit;
            line-height: 1.5;
        }

        .input-container textarea::placeholder {
            color: var(--text-muted);
        }

        .input-container textarea:focus { outline: none; }

        .input-container button {
            background: var(--gradient-primary);
            border: none;
            color: #fff;
            padding: 0 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-container button:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-glow);
        }

        .input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
        }

        .loading-dots {
            display: flex;
            gap: 6px;
        }

        .loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: pulse 1.4s infinite ease-in-out both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes pulse {
            0%, 80%, 100% { transform: scale(0.6); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Markdown styling */
        .message-content h1, .message-content h2, .message-content h3 {
            color: var(--accent-primary);
            margin: 18px 0 10px 0;
        }
        .message-content h2 { font-size: 16px; }
        .message-content h3 { font-size: 14px; }
        .message-content ul, .message-content ol { margin: 12px 0; padding-left: 24px; }
        .message-content li { margin: 6px 0; }
        .message-content .prompt-hints { list-style: none; padding-left: 0; }
        .message-content .prompt-hints li {
            cursor: pointer;
            padding: 8px 12px;
            margin: 4px 0;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            color: var(--accent-primary);
        }
        .message-content .prompt-hints li:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }
        .message-content code {
            background: var(--bg-primary);
            padding: 3px 8px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--accent-primary);
        }
        .message-content pre {
            background: var(--bg-primary);
            padding: 16px;
            border-radius: 12px;
            overflow-x: auto;
            margin: 12px 0;
            border: 1px solid var(--border-color);
        }
        .message-content pre code { background: none; padding: 0; color: var(--text-secondary); }
        .message-content strong { color: var(--accent-primary); font-weight: 600; }

        /* Compact diagnostic output styling */
        .message-content h2, .message-content h3 {
            margin-top: 16px;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border-color);
        }

        .message-content h2:first-child, .message-content h3:first-child {
            margin-top: 0;
        }

        .message-content ol, .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content ol ol, .message-content ol ul,
        .message-content ul ol, .message-content ul ul {
            margin: 4px 0;
        }

        .message-content li {
            margin: 2px 0;
            line-height: 1.4;
        }

        .message-content ol {
            list-style-type: decimal;
        }

        .message-content li > strong:first-child {
            color: var(--text-primary);
        }

        .message-content p {
            margin: 6px 0;
        }

        .message-content p:first-child {
            margin-top: 0;
        }

        /* Key findings, recommendations styling */
        .message-content li code {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.2);
        }

        /* Agent questions - stand out from informational content */
        .message-content .agent-question {
            background: rgba(0, 217, 255, 0.08);
            border-left: 3px solid var(--accent-primary);
            padding: 10px 14px;
            margin: 12px 0 4px 0;
            border-radius: 0 8px 8px 0;
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 950px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.95) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            z-index: 10;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--accent-error);
            color: var(--accent-error);
        }

        .modal-body { padding: 24px; }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.3s;
        }

        .chart-card:hover {
            border-color: var(--border-glow);
        }

        .chart-card h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ops-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ops-table th, .ops-table td {
            padding: 12px;
            text-align: left;
            font-size: 12px;
        }

        .ops-table th {
            color: var(--accent-primary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-color);
        }

        .ops-table td {
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .ops-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .chart-row { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
        }

        /* Empty state */
        .empty-state {
            color: var(--text-muted);
            font-size: 12px;
            text-align: center;
            padding: 16px;
        }

        /* Auto-refresh controls */
        .refresh-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 20px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--border-color);
        }

        .toggle-switch.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            background: var(--text-secondary);
            border-radius: 50%;
            transition: all 0.3s;
        }

        .toggle-switch.active::after {
            transform: translateX(16px);
            background: white;
        }

        .modal-refresh-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .modal-refresh-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-refresh-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .modal-refresh-btn.spinning svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .auto-refresh-indicator {
            font-size: 10px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .auto-refresh-indicator.active {
            color: var(--accent-success);
        }

        .auto-refresh-indicator .dot {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
        }

        .auto-refresh-indicator.active .dot {
            background: var(--accent-success);
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Service selector dropdown */
        .modal-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            min-width: 180px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
            transition: all 0.2s;
        }

        .service-selector:hover {
            border-color: var(--accent-primary);
        }

        .service-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        .service-selector option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        .modal-type-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-type-badge.service {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .modal-type-badge.database {
            background: rgba(124, 58, 237, 0.15);
            color: var(--accent-secondary);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .modal-type-badge.container {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* Time window selector */
        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .chart-card-header h4 {
            margin-bottom: 0;
        }

        .time-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            padding: 4px 8px;
            font-size: 10px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%23a0a0b0' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 6px center;
            padding-right: 22px;
            transition: all 0.2s;
        }

        .time-selector:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .time-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .time-selector option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* Error modal styling */
        .modal-type-badge.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-error);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .error-detail-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .error-detail-card h4 {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .error-detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .error-detail-label {
            color: var(--text-muted);
            width: 120px;
            flex-shrink: 0;
        }

        .error-detail-value {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
        }

        .error-detail-value.error-text {
            color: var(--accent-error);
        }

        .trace-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .trace-table th {
            background: var(--bg-tertiary);
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
        }

        .trace-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .trace-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .trace-table tr.error-row td {
            background: rgba(239, 68, 68, 0.08);
        }

        .trace-depth {
            color: var(--text-muted);
            font-size: 10px;
        }

        /* Error summary card */
        .error-summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .error-summary-card:hover {
            border-color: var(--border-glow);
        }

        .error-summary-card.has-errors {
            border-left: 3px solid var(--accent-error);
        }

        .error-summary-card.no-errors {
            border-left: 3px solid var(--accent-success);
        }

        .error-summary-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .error-count {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-error);
        }

        .error-count.zero {
            color: var(--accent-success);
        }

        .error-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .error-services {
            text-align: right;
        }

        .error-services-count {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .expand-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            text-align: center;
        }

        .errors-list-collapsed {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .errors-list-expanded {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 8px;
        }

        /* Progress indicator for chat */
        .progress-container {
            margin-top: 12px;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .progress-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .progress-step {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-message {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .progress-detail {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            margin-top: 6px;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 6px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .progress-steps {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .progress-step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: all 0.3s;
        }

        .progress-step-dot.active {
            background: var(--accent-primary);
            box-shadow: 0 0 8px var(--accent-primary);
        }

        .progress-step-dot.completed {
            background: var(--accent-success);
        }

        .query-progress-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 6px 8px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .query-progress-item .check {
            color: var(--accent-success);
            font-weight: bold;
        }

        .query-progress-item .rows {
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Host metrics styling */
        .host-item {
            padding: 10px 12px;
            margin: -2px -8px;
            border-radius: 10px;
        }

        .host-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .host-metrics {
            display: flex;
            gap: 8px;
        }

        .host-metric {
            flex: 1;
            text-align: center;
            padding: 6px;
            background: var(--bg-primary);
            border-radius: 6px;
        }

        .host-metric-value {
            font-size: 14px;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
        }

        .host-metric-label {
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-ok { color: var(--accent-success); }
        .metric-warn { color: var(--accent-warning); }
        .metric-error { color: var(--accent-error); }

        .host-item:hover {
            background: var(--bg-secondary);
            transition: background 0.2s ease;
        }

        /* Host modal styling */
        .host-detail-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .host-metric-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .host-metric-card .value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .host-metric-card .label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 8px;
        }

        .host-info {
            display: grid;
            gap: 12px;
        }

        .host-info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .host-info-label {
            color: var(--text-muted);
            font-size: 12px;
        }

        .host-info-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        /* Topology graph styling */
        .topology-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 16px;
            margin: 16px 0;
            max-width: 800px;
        }

        .topology-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .topology-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .topology-graph {
            height: 400px;
            background: var(--bg-primary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .topology-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.service { background: #00d9ff; }
        .legend-dot.database { background: #7c3aed; }
        .legend-dot.external { background: #f59e0b; }
        .legend-dot.error { background: #ef4444; }

        /* Modal tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 0 24px 16px 24px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .modal-tab {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-tab:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .modal-tab.active {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
            border-bottom-color: var(--bg-primary);
            color: var(--accent-primary);
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .tab-badge {
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .modal-tab.active .tab-badge {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
        }

        /* Data tables for logs/traces/metrics */
        .data-table-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }

        .data-table th {
            background: var(--bg-tertiary);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: var(--accent-primary);
            text-transform: uppercase;
            font-size: 10px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .data-table tr.error-row td {
            background: rgba(239, 68, 68, 0.08);
        }

        .data-table-wrapper {
            max-height: 400px;
            overflow-y: auto;
        }

        .severity-debug { color: var(--text-muted); }
        .severity-info { color: var(--accent-primary); }
        .severity-warn { color: var(--accent-warning); }
        .severity-error { color: var(--accent-error); }

        .log-body {
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .log-body:hover {
            white-space: normal;
            word-break: break-all;
        }

        .tab-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .tab-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Dependencies list */
        .deps-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .dep-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .dep-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .dep-item:last-child {
            border-bottom: none;
        }

        .dep-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .dep-type-badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .dep-type-badge.service {
            background: rgba(0, 217, 255, 0.15);
            color: var(--accent-primary);
        }

        .dep-type-badge.database {
            background: rgba(124, 58, 237, 0.15);
            color: var(--accent-secondary);
        }

        .dep-calls {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Help Modal Styles */
        .help-modal {
            max-width: 900px;
        }

        .help-body {
            padding: 24px;
        }

        .architecture-diagram {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .arch-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .arch-row:last-child {
            margin-bottom: 0;
        }

        .arch-component {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .arch-component:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }

        .arch-component.apps { border-left: 3px solid #10b981; }
        .arch-component.collector { border-left: 3px solid #f59e0b; }
        .arch-component.kafka { border-left: 3px solid #ef4444; }
        .arch-component.ingester { border-left: 3px solid #8b5cf6; }
        .arch-component.database { border-left: 3px solid #06b6d4; }
        .arch-component.trino { border-left: 3px solid #ec4899; }
        .arch-component.ui { border-left: 3px solid #00d9ff; }

        .arch-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .arch-label {
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .arch-desc {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .arch-arrow {
            font-size: 24px;
            color: var(--accent-primary);
            font-weight: bold;
        }

        .help-section {
            margin-bottom: 24px;
        }

        .help-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .data-flow-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .flow-card {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border-color);
        }

        .flow-card.traces { border-left: 3px solid #7c3aed; }
        .flow-card.metrics { border-left: 3px solid #10b981; }
        .flow-card.logs { border-left: 3px solid #f59e0b; }

        .flow-icon {
            font-size: 24px;
        }

        .flow-name {
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .flow-path {
            font-size: 10px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .how-it-works {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 16px 16px 16px 32px;
            margin: 0;
        }

        .how-it-works li {
            margin: 8px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .how-it-works li strong {
            color: var(--accent-primary);
        }

        .diagnostic-steps {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .diag-step {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .step-num {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .data-flow-cards,
            .diagnostic-steps {
                grid-template-columns: 1fr;
            }
            .arch-row {
                flex-direction: column;
            }
            .arch-arrow {
                transform: rotate(90deg);
            }
        }

        /* Alert Detail Modal */
        .alert-modal {
            max-width: 700px;
        }

        .alert-detail-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .alert-detail-severity {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .alert-detail-severity.critical {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-error);
        }

        .alert-detail-severity.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-warning);
        }

        .alert-detail-severity.info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--accent-primary);
        }

        .alert-detail-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .alert-detail-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .alert-meta-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .alert-meta-label {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .alert-meta-value {
            font-size: 13px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .alert-section {
            margin-bottom: 20px;
        }

        .alert-section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-section-content {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .alert-section-content.root-cause {
            border-left: 3px solid var(--accent-error);
            color: var(--text-primary);
            font-weight: 500;
        }

        .alert-section-content.actions {
            border-left: 3px solid var(--accent-success);
        }

        .alert-section-content.evidence {
            border-left: 3px solid var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }

        .alert-no-investigation {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .alert-no-investigation-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .alert-no-investigation-text {
            font-size: 14px;
            margin-bottom: 20px;
        }

        .alert-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .alert-action-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .alert-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
        }

        .alert-action-btn.primary:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .alert-action-btn.secondary {
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .alert-action-btn.secondary:hover {
            background: var(--bg-tertiary);
        }

        .alert-action-btn.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .alert-action-btn.warning:hover {
            background: rgba(245, 158, 11, 0.25);
        }

        .alert-investigation-stats {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .alert-investigation-stats span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Predictions Sidebar */
        .predictions-list .prediction-item {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }

        .predictions-list .prediction-item:hover {
            background: rgba(0, 217, 255, 0.05);
        }

        .prediction-resource {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .prediction-resource .resource-icon {
            font-size: 14px;
        }

        .prediction-detail {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .prediction-confidence {
            display: inline-block;
            padding: 1px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 6px;
        }

        .prediction-confidence.high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .prediction-confidence.medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
        .prediction-confidence.low { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }

        .predictions-badge {
            background: var(--accent-warning);
            color: #fff;
            font-size: 10px;
            font-weight: 700;
            padding: 1px 6px;
            border-radius: 8px;
            margin-left: 6px;
        }

        /* Incident Context */
        .incident-context-section {
            margin-top: 12px;
            border-top: 1px solid var(--border);
            padding-top: 12px;
        }

        .context-toggle {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 6px 0;
        }

        .context-toggle .arrow {
            transition: transform 0.2s;
            font-size: 10px;
        }

        .context-toggle.open .arrow {
            transform: rotate(90deg);
        }

        .context-body {
            display: none;
            margin-top: 8px;
        }

        .context-body.open {
            display: block;
        }

        .context-metric-table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        .context-metric-table th,
        .context-metric-table td {
            padding: 3px 6px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .context-metric-table th {
            color: var(--text-muted);
            font-weight: 600;
        }

        .context-traces-list,
        .context-logs-list {
            max-height: 200px;
            overflow-y: auto;
            font-size: 11px;
        }

        .context-trace-item,
        .context-log-item {
            padding: 3px 0;
            border-bottom: 1px solid var(--border);
        }

        .pattern-info {
            margin-top: 8px;
            padding: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 6px;
            border: 1px solid rgba(124, 58, 237, 0.2);
            font-size: 12px;
        }

        .pattern-info strong {
            color: var(--accent-secondary);
        }

        /* Simulation Header Controls */
        .sim-header-controls {
            display: flex;
            flex-direction: column;
            flex: 1;
            max-width: 600px;
            margin: 0 24px;
            gap: 2px;
        }

        .sim-header-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .sim-header-controls select {
            padding: 6px 10px;
            font-size: 12px;
            min-width: 180px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .sim-start-btn, .sim-stop-btn, .sim-undo-btn {
            padding: 6px 14px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            border: none;
            white-space: nowrap;
        }

        .sim-start-btn {
            background: var(--accent-success);
            color: #fff;
        }

        .sim-start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sim-stop-btn {
            background: var(--accent-error);
            color: #fff;
        }

        .sim-undo-btn {
            background: #d97706;
            color: #fff;
        }

        .sim-undo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .sim-header-progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sim-progress-bar {
            width: 150px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .sim-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.5s;
        }

        .sim-elapsed {
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            color: var(--text-muted);
        }

        .sim-header-step {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">O</div>
            <span class="logo-text">Observability</span>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Recent Errors</span>
                <div class="refresh-controls">
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch active" id="sidebar-auto-toggle" onclick="toggleSidebarAutoRefresh()"></div>
                    </div>
                    <button class="refresh-btn" onclick="refreshStatus()">Refresh</button>
                </div>
            </div>
            <div id="error-summary" class="error-summary-card">
                <div class="empty-state">Loading...</div>
            </div>
            <div id="errors-list" class="errors-list-collapsed"></div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Alerts</span>
                <span id="alerts-badge" class="alerts-badge" style="display: none;">0</span>
            </div>
            <div id="combined-alerts-list" class="combined-alerts-list" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state">No alerts</div>
            </div>
        </div>

        <div id="entity-sections">
            <!-- Populated dynamically by refreshStatus() -->
            <div class="sidebar-section">
                <div class="section-header">
                    <span class="section-title">Services</span>
                    <select class="time-selector" id="services-time-selector" onchange="refreshStatus()">
                        <option value="1m">1m</option>
                        <option value="5m">5m</option>
                        <option value="15m">15m</option>
                        <option value="1h" selected>1h</option>
                    </select>
                </div>
                <div class="status-card">
                    <div class="status-card-title">Click to drill down</div>
                    <div id="services-list"><div class="empty-state">Loading...</div></div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="section-header">
                    <span class="section-title">Databases</span>
                </div>
                <div class="status-card">
                    <div class="status-card-title">Click to drill down</div>
                    <div id="databases-list"><div class="empty-state">Loading...</div></div>
                </div>
            </div>
            <div class="sidebar-section">
                <div class="section-header">
                    <span class="section-title">Hosts</span>
                </div>
                <div class="status-card">
                    <div class="status-card-title">System resources</div>
                    <div id="hosts-list"><div class="empty-state">Loading...</div></div>
                </div>
            </div>
        </div>

        <div class="sidebar-section">
            <div class="section-header">
                <span class="section-title">Background Jobs</span>
            </div>
            <div id="jobs-list" class="status-card">
                <div class="empty-state">Loading...</div>
            </div>
        </div>

        <div class="last-updated">Last updated: <span id="last-updated">-</span></div>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Diagnostic Chat</h1>
            <div class="sim-header-controls">
                <div class="sim-header-row">
                    <select id="sim-scenario-select" onchange="updateScenarioDescription()">
                        <option value="">Select scenario...</option>
                    </select>
                    <button class="sim-start-btn" id="sim-start-btn" onclick="startSimulation()" disabled>&#9654; Start</button>
                    <button class="sim-stop-btn" id="sim-stop-btn" onclick="stopSimulation()" style="display:none;">&#9632; Stop</button>
                    <button class="sim-undo-btn" id="sim-undo-btn" onclick="undoScenario()" disabled>&#8617; Undo</button>
                    <div class="sim-header-progress" id="sim-header-progress" style="display:none;">
                        <div class="sim-progress-bar">
                            <div class="sim-progress-fill" id="sim-progress-fill" style="width:0%"></div>
                        </div>
                        <span class="sim-elapsed" id="sim-elapsed"></span>
                    </div>
                </div>
                <div class="sim-header-step" id="sim-header-step" style="display:none;"></div>
            </div>
            <div class="header-actions">
                <button onclick="openHelpModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    Help
                </button>
                <button onclick="clearChat()">Clear Chat</button>
            </div>
        </header>

        <div class="chat-container" id="chat-container">
            <div class="message assistant">
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <p>Hello! I'm your observability diagnostic assistant. I can help you investigate issues by querying logs, metrics, and traces.</p>
                    <p><strong>Example questions:</strong></p>
                    <ul class="prompt-hints">
                        <li onclick="setPrompt(&quot;The frontend is slow, what's wrong?&quot;)">The frontend is slow, what's wrong?</li>
                        <li onclick="setPrompt('Show me errors in the last 5 minutes')">Show me errors in the last 5 minutes</li>
                        <li onclick="setPrompt('Show me a graph of latency for checkout service')">Show me a graph of latency for checkout service</li>
                        <li onclick="setPrompt('Chart error rates by service over the last hour')">Chart error rates by service over the last hour</li>
                        <li onclick="setPrompt('Show me the topology for PostgreSQL - what depends on it?')">Show me the topology for PostgreSQL - what depends on it?</li>
                        <li onclick="setPrompt('What does the frontend depend on?')">What does the frontend depend on? (show upstream deps)</li>
                    </ul>
                    <p>What would you like to investigate?</p>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <textarea id="message-input" placeholder="Describe the issue or ask for a visualization..." onkeydown="handleKeyDown(event)"></textarea>
                <button id="send-btn" onclick="sendMessage()">
                    <span>Send</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <!-- Generic Entity Drill-down Modal -->
    <div class="modal-overlay" id="entity-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge" id="entity-type-badge">Entity</span>
                    <select class="service-selector" id="entity-selector" onchange="switchEntity(this.value)">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="modal-refresh-controls">
                    <div class="auto-refresh-indicator" id="entity-modal-auto-indicator">
                        <span class="dot"></span>
                        <span>Auto-refresh off</span>
                    </div>
                    <div class="toggle-container">
                        <span class="toggle-label">Auto</span>
                        <div class="toggle-switch" id="entity-modal-auto-toggle" onclick="toggleEntityModalAutoRefresh()"></div>
                    </div>
                    <button class="modal-refresh-btn" id="entity-modal-refresh-btn" onclick="refreshEntityModal()">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                        Refresh
                    </button>
                    <button class="modal-refresh-btn" onclick="askAboutEntity(currentEntityType, currentEntityName)" title="Ask about this entity">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                        </svg>
                        Ask
                    </button>
                    <button class="modal-close" onclick="closeEntityModal()">&times;</button>
                </div>
            </div>
            <div class="modal-tabs" id="entity-modal-tabs">
                <!-- Built dynamically by openEntityModal -->
            </div>
            <div class="modal-body" id="entity-modal-body">
                <!-- Built dynamically by tab loaders -->
            </div>
        </div>
    </div>

    <!-- Error Drill-down Modal -->
    <div class="modal-overlay" id="error-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <span class="modal-type-badge" id="trace-detail-badge" style="background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);">Trace</span>
                    <h2 id="error-modal-title">Span Details</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeErrorModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="error-modal-body">
                <div class="error-detail-card">
                    <h4>Span Information</h4>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Service:</span>
                        <span class="error-detail-value" id="error-service">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Operation:</span>
                        <span class="error-detail-value" id="error-operation">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Timestamp:</span>
                        <span class="error-detail-value" id="error-timestamp">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Duration:</span>
                        <span class="error-detail-value" id="error-duration">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Trace ID:</span>
                        <span class="error-detail-value" id="error-trace-id">-</span>
                    </div>
                </div>

                <div class="error-detail-card" id="exception-card" style="display: none;">
                    <h4>Exception Details</h4>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Type:</span>
                        <span class="error-detail-value error-text" id="exception-type">-</span>
                    </div>
                    <div class="error-detail-row">
                        <span class="error-detail-label">Message:</span>
                        <span class="error-detail-value error-text" id="exception-message">-</span>
                    </div>
                </div>

                <div class="error-detail-card">
                    <h4>Full Trace</h4>
                    <div style="overflow-x: auto;">
                        <table class="trace-table" id="trace-table">
                            <thead>
                                <tr>
                                    <th>Service</th>
                                    <th>Operation</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal with Architecture Diagram -->
    <div class="modal-overlay" id="help-modal">
        <div class="modal help-modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <h2>System Architecture</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeHelpModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body help-body">
                <div class="architecture-diagram">
                    <div class="arch-row">
                        <div class="arch-component apps">
                            <div class="arch-icon"></div>
                            <div class="arch-label">OTel Demo Apps</div>
                            <div class="arch-desc">Instrumented services generating telemetry</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component collector">
                            <div class="arch-icon"></div>
                            <div class="arch-label">OTel Collector</div>
                            <div class="arch-desc">Receives, processes, exports telemetry</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component kafka">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Vast Kafka</div>
                            <div class="arch-desc">Message broker (3 topics)</div>
                        </div>
                    </div>
                    <div class="arch-row">
                        <div class="arch-component ingester">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Ingester</div>
                            <div class="arch-desc">Consumes Kafka, writes to DB</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component database">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Vast DB</div>
                            <div class="arch-desc">Stores logs, metrics, traces</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component trino">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Trino</div>
                            <div class="arch-desc">SQL query engine</div>
                        </div>
                        <div class="arch-arrow"></div>
                        <div class="arch-component ui">
                            <div class="arch-icon"></div>
                            <div class="arch-label">Agentic UI</div>
                            <div class="arch-desc">AI-powered diagnostics</div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3> Data Flow</h3>
                    <div class="data-flow-cards">
                        <div class="flow-card traces">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Traces</div>
                                <div class="flow-path">otel-traces  spans_otel_analytic</div>
                            </div>
                        </div>
                        <div class="flow-card metrics">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Metrics</div>
                                <div class="flow-path">otel-metrics  metrics_otel_analytic</div>
                            </div>
                        </div>
                        <div class="flow-card logs">
                            <div class="flow-icon"></div>
                            <div class="flow-info">
                                <div class="flow-name">Logs</div>
                                <div class="flow-path">otel-logs  logs_otel_analytic</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3> How It Works</h3>
                    <ol class="how-it-works">
                        <li><strong>Ask a question</strong> in natural language (e.g., "Why is checkout slow?")</li>
                        <li><strong>AI generates SQL</strong> queries to investigate logs, metrics, and traces</li>
                        <li><strong>Queries run via Trino</strong> against Vast DB observability data</li>
                        <li><strong>AI analyzes results</strong> and follows the diagnostic process</li>
                        <li><strong>Root cause identified</strong> with supporting evidence</li>
                    </ol>
                </div>

                <div class="help-section">
                    <h3> Diagnostic Process</h3>
                    <div class="diagnostic-steps">
                        <div class="diag-step">
                            <span class="step-num">1</span>
                            <span class="step-text">Check infrastructure health (databases, hosts, services)</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">2</span>
                            <span class="step-text">Look for connection errors, timeouts, missing telemetry</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">3</span>
                            <span class="step-text">Trace errors through the dependency chain</span>
                        </div>
                        <div class="diag-step">
                            <span class="step-num">4</span>
                            <span class="step-text">Identify the root cause component</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Detail Modal -->
    <div class="modal-overlay" id="alert-modal">
        <div class="modal alert-modal">
            <div class="modal-header">
                <div class="modal-title-row">
                    <h2>Alert Details</h2>
                </div>
                <div class="modal-refresh-controls">
                    <button class="modal-close" onclick="closeAlertModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="alert-modal-content">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        const sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let isLoading = false;
        let modalCharts = {};
        let chatCharts = [];

        // History buffers for sidebar persistence
        const MAX_HISTORY = 50;
        const errorHistory = new Map();    // key: trace_id + '_' + span_id
        const alertHistory = new Map();    // key: alert_id
        const forecastHistory = new Map(); // key: prediction_id

        // Auto-refresh state
        let sidebarAutoRefresh = true;
        let sidebarRefreshInterval = null;
        let entityModalAutoRefresh = false;
        let entityModalRefreshInterval = null;
        let currentEntityType = null;
        let currentEntityName = null;
        // Legacy compat aliases
        let modalAutoRefresh = false;
        let modalRefreshInterval = null;
        let currentModalService = null;
        let dbModalAutoRefresh = false;
        let dbModalRefreshInterval = null;
        let currentModalDatabase = null;
        let hostModalAutoRefresh = false;
        let hostModalRefreshInterval = null;
        let currentModalHost = null;
        let availableServices = [];
        let availableDatabases = [];
        let availableEntities = {};
        let alertsConfig = { investigate_critical_only: false };

        // =================================================================
        // Entity Configuration (mirrors backend ENTITY_TYPES)
        // =================================================================
        const ENTITY_CONFIG = {
            service: {
                displayName: 'Service',
                nameField: 'service_name',
                badgeClass: 'service',
                tabs: [
                    { id: 'charts', label: 'Charts', loader: 'loadEntityCharts' },
                    { id: 'deps', label: 'Dependencies', loader: 'loadEntityDeps' },
                    { id: 'topology', label: 'Topology', loader: 'loadEntityTopology' },
                    { id: 'traces', label: 'Traces', loader: 'loadEntityTraces', hasBadge: true },
                    { id: 'logs', label: 'Logs', loader: 'loadEntityLogs', hasBadge: true },
                    { id: 'metrics', label: 'Metrics', loader: 'loadEntityMetrics', hasBadge: true },
                ],
                defaultTab: 'charts',
                chartsConfig: { latency: true, errors: true, throughput: true, topOperations: true },
                sidebarRenderer: 'renderServiceItem',
            },
            database: {
                displayName: 'Database',
                nameField: 'db_system',
                badgeClass: 'database',
                tabs: [
                    { id: 'charts', label: 'Charts', loader: 'loadEntityCharts' },
                    { id: 'deps', label: 'Dependencies', loader: 'loadEntityDeps' },
                    { id: 'topology', label: 'Topology', loader: 'loadEntityTopology' },
                    { id: 'traces', label: 'Traces', loader: 'loadEntityTraces', hasBadge: true },
                    { id: 'logs', label: 'Logs', loader: 'loadEntityLogs', hasBadge: true },
                    { id: 'metrics', label: 'Metrics', loader: 'loadEntityMetrics', hasBadge: true },
                ],
                defaultTab: 'charts',
                chartsConfig: { latency: true, errors: true, volume: true, slowQueries: true, deadlocks: true, dbSize: true },
                sidebarRenderer: 'renderDatabaseItem',
            },
            host: {
                displayName: 'Host',
                nameField: 'host_name',
                badgeClass: 'host',
                tabs: [
                    { id: 'overview', label: 'Metrics', loader: 'loadEntityOverview' },
                    { id: 'services', label: 'Services', loader: 'loadEntityServices' },
                    { id: 'topology', label: 'Topology', loader: 'loadEntityTopology' },
                    { id: 'traces', label: 'Traces', loader: 'loadEntityTraces', hasBadge: true },
                    { id: 'logs', label: 'Logs', loader: 'loadEntityLogs', hasBadge: true },
                    { id: 'metrics', label: 'All Metrics', loader: 'loadEntityMetrics', hasBadge: true },
                ],
                defaultTab: 'overview',
                chartsConfig: {},
                sidebarRenderer: 'renderHostItem',
            },
            container: {
                displayName: 'Container',
                nameField: 'container_name',
                badgeClass: 'container',
                tabs: [
                    { id: 'overview', label: 'Metrics', loader: 'loadContainerOverview' },
                    { id: 'logs', label: 'Logs', loader: 'loadEntityLogs', hasBadge: true },
                    { id: 'metrics', label: 'All Metrics', loader: 'loadEntityMetrics', hasBadge: true },
                ],
                defaultTab: 'overview',
                chartsConfig: {},
                sidebarRenderer: 'renderContainerItem',
            },
        };
        const REFRESH_INTERVAL = 15000; // 15 seconds for sidebar
        const MODAL_REFRESH_INTERVAL = 30000; // 30 seconds for drill-down modal (reads pre-computed rollups)

        const chartColors = ['#00d9ff', '#7c3aed', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];

        Chart.defaults.color = '#a0a0b0';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.06)';

        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch alerts config
            try {
                const configResp = await fetch('/api/alerts/config');
                alertsConfig = await configResp.json();
            } catch (e) {
                console.error('Failed to fetch alerts config:', e);
            }
            refreshStatus();
            startSidebarAutoRefresh();
            initSimulator();
        });

        function startSidebarAutoRefresh() {
            if (sidebarRefreshInterval) clearInterval(sidebarRefreshInterval);
            if (sidebarAutoRefresh) {
                sidebarRefreshInterval = setInterval(refreshStatus, REFRESH_INTERVAL);
            }
        }

        function toggleErrorsList() {
            const errorsList = document.getElementById('errors-list');
            const errorSummary = document.getElementById('error-summary');
            const expandHint = errorSummary.querySelector('.expand-hint');

            if (errorsList.classList.contains('errors-list-expanded')) {
                errorsList.className = 'errors-list-collapsed';
                if (expandHint) expandHint.textContent = 'Click to expand';
            } else {
                errorsList.className = 'errors-list-expanded';
                if (expandHint) expandHint.textContent = 'Click to collapse';
            }
        }

        function toggleSidebarAutoRefresh() {
            sidebarAutoRefresh = !sidebarAutoRefresh;
            const toggle = document.getElementById('sidebar-auto-toggle');
            toggle.classList.toggle('active', sidebarAutoRefresh);

            if (sidebarAutoRefresh) {
                startSidebarAutoRefresh();
            } else {
                if (sidebarRefreshInterval) {
                    clearInterval(sidebarRefreshInterval);
                    sidebarRefreshInterval = null;
                }
            }
        }

        // Old service modal auto-refresh functions removed - using generic entity functions now

        function setPrompt(text) {
            const input = document.getElementById('message-input');
            input.value = text;
            input.focus();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            if (!message || isLoading) return;

            isLoading = true;
            document.getElementById('send-btn').disabled = true;
            addMessage('user', message);
            input.value = '';

            const loadingId = addLoading();
            let completedQueries = [];

            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, session_id: sessionId })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                handleStreamEvent(loadingId, data, completedQueries);
                            } catch (e) {
                                console.error('Failed to parse SSE data:', e);
                            }
                        }
                    }
                }

            } catch (error) {
                removeLoading(loadingId);
                addMessage('assistant', `Error: ${error.message}`);
            }

            isLoading = false;
            document.getElementById('send-btn').disabled = false;
            refreshStatus();
        }

        function handleStreamEvent(loadingId, data, completedQueries) {
            const loadingDiv = document.getElementById(loadingId);
            if (!loadingDiv) return;

            if (data.type === 'status') {
                updateLoadingProgress(loadingDiv, data.message, data.step, data.detail, completedQueries);
            } else if (data.type === 'query_result') {
                completedQueries.push({
                    index: data.query_index,
                    rows: data.row_count,
                    success: data.success
                });
                updateLoadingQueries(loadingDiv, completedQueries);
            } else if (data.type === 'complete') {
                removeLoading(loadingId);
                addMessage('assistant', data.response, data.queries, data.charts, data.topologies);
            } else if (data.type === 'error') {
                removeLoading(loadingId);
                addMessage('assistant', `Error: ${data.message}`);
            }
        }

        function updateLoadingProgress(loadingDiv, message, step, detail, completedQueries) {
            const progressContainer = loadingDiv.querySelector('.progress-container');
            if (!progressContainer) return;

            const progressMessage = progressContainer.querySelector('.progress-message');
            const progressDetail = progressContainer.querySelector('.progress-detail');
            const stepDots = progressContainer.querySelectorAll('.progress-step-dot');

            if (progressMessage) progressMessage.textContent = message;

            if (detail) {
                if (progressDetail) {
                    progressDetail.textContent = detail;
                    progressDetail.style.display = 'block';
                }
            } else if (progressDetail) {
                progressDetail.style.display = 'none';
            }

            // Update step dots
            stepDots.forEach((dot, i) => {
                if (i < step - 1) {
                    dot.className = 'progress-step-dot completed';
                } else if (i === step - 1) {
                    dot.className = 'progress-step-dot active';
                } else {
                    dot.className = 'progress-step-dot';
                }
            });
        }

        function updateLoadingQueries(loadingDiv, completedQueries) {
            const queriesContainer = loadingDiv.querySelector('.queries-progress');
            if (!queriesContainer) return;

            queriesContainer.innerHTML = completedQueries.map(q =>
                `<div class="query-progress-item">
                    <span class="check">${q.success ? '' : ''}</span>
                    <span>Query ${q.index + 1}</span>
                    <span class="rows">${q.rows} rows</span>
                </div>`
            ).join('');
        }

        function addMessage(role, content, queries = [], charts = [], topologies = []) {
            const container = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            let queriesHtml = '';
            if (queries && queries.length > 0) {
                queriesHtml = queries.map((q, i) => `
                    <div class="query-block">
                        <div class="query-header" onclick="toggleQuery(this)">
                            <span>Query ${i + 1}: ${q.result.row_count || 0} rows</span>
                            <span>&#9662;</span>
                        </div>
                        <div class="query-content" style="display: none;">
                            <div class="query-sql">${escapeHtml(q.sql)}</div>
                            <div class="query-results">${formatQueryResults(q.result)}</div>
                        </div>
                    </div>
                `).join('');
            }

            let chartsHtml = '';
            if (charts && charts.length > 0) {
                chartsHtml = charts.map((chart, i) => {
                    const chartId = `chat-chart-${Date.now()}-${i}`;
                    setTimeout(() => renderChart(chartId, chart), 100);
                    return `<div class="chart-container"><canvas id="${chartId}"></canvas></div>`;
                }).join('');
            }

            let topologiesHtml = '';
            if (topologies && topologies.length > 0) {
                topologiesHtml = topologies.map((topo, i) => {
                    const topoId = `topology-${Date.now()}-${i}`;
                    setTimeout(() => renderTopology(topoId, topo), 100);
                    return `
                        <div class="topology-container">
                            <div class="topology-title">${escapeHtml(topo.title)}</div>
                            <div class="topology-graph" id="${topoId}"></div>
                            <div class="topology-legend">
                                <div class="legend-item"><div class="legend-dot service"></div>Service</div>
                                <div class="legend-item"><div class="legend-dot database"></div>Database</div>
                                <div class="legend-item"><div class="legend-dot external"></div>External</div>
                                <div class="legend-item"><div class="legend-dot error"></div>Error</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            messageDiv.innerHTML = `
                <div class="message-label">${role === 'user' ? 'You' : 'Assistant'}</div>
                <div class="message-content">${formatMarkdown(content)}</div>
                ${chartsHtml}
                ${topologiesHtml}
                ${queriesHtml}
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function renderChart(canvasId, chartData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');

            const datasets = chartData.datasets.map((ds, i) => ({
                label: ds.label,
                data: ds.data,
                borderColor: ds.color || chartColors[i % chartColors.length],
                backgroundColor: chartData.chart_type === 'line'
                    ? 'transparent'
                    : (ds.color || chartColors[i % chartColors.length]) + '40',
                tension: 0.4,
                fill: chartData.chart_type === 'line' ? false : true,
                pointRadius: 3,
                pointHoverRadius: 6
            }));

            new Chart(ctx, {
                type: chartData.chart_type,
                data: { labels: chartData.labels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: { display: true, text: chartData.title, color: '#00d9ff', font: { size: 14, weight: 600 } },
                        legend: { labels: { color: '#a0a0b0', font: { size: 11 } } }
                    },
                    scales: chartData.chart_type !== 'doughnut' ? {
                        x: { ticks: { color: '#606070' }, grid: { color: 'rgba(255,255,255,0.04)' } },
                        y: { ticks: { color: '#606070' }, grid: { color: 'rgba(255,255,255,0.04)' } }
                    } : undefined
                }
            });
        }

        function renderTopology(containerId, topoData) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Node colors by type and status
            const nodeColors = {
                service: { background: '#00d9ff', border: '#00a3cc', font: '#ffffff' },
                database: { background: '#7c3aed', border: '#5b21b6', font: '#ffffff' },
                external: { background: '#f59e0b', border: '#d97706', font: '#ffffff' }
            };

            const statusColors = {
                healthy: '#10b981',
                warning: '#f59e0b',
                error: '#ef4444'
            };

            // Convert nodes to vis.js format
            const nodes = new vis.DataSet(topoData.nodes.map(node => {
                const typeColor = nodeColors[node.type] || nodeColors.service;
                const borderColor = node.status === 'error' ? statusColors.error :
                                   node.status === 'warning' ? statusColors.warning : typeColor.border;
                return {
                    id: node.id,
                    label: node.label,
                    color: {
                        background: typeColor.background,
                        border: borderColor,
                        highlight: { background: typeColor.background, border: '#ffffff' }
                    },
                    font: { color: typeColor.font, size: 12, face: 'Inter' },
                    shape: node.type === 'database' ? 'database' : 'box',
                    borderWidth: node.status ? 3 : 2,
                    shadow: true
                };
            }));

            // Convert edges to vis.js format
            const edges = new vis.DataSet(topoData.edges.map(edge => ({
                from: edge.from,
                to: edge.to,
                label: edge.label || '',
                arrows: 'to',
                color: { color: '#606070', highlight: '#00d9ff' },
                font: { color: '#a0a0b0', size: 10, face: 'Inter', strokeWidth: 0 },
                smooth: { type: 'cubicBezier', roundness: 0.5 }
            })));

            // Create the network
            const options = {
                physics: {
                    stabilization: { iterations: 100 },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.3,
                        springLength: 150,
                        springConstant: 0.04
                    }
                },
                layout: {
                    improvedLayout: true
                },
                interaction: {
                    hover: true,
                    tooltipDelay: 200
                }
            };

            new vis.Network(container, { nodes, edges }, options);
        }

        function addLoading() {
            const container = document.getElementById('chat-container');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading_' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message assistant';
            loadingDiv.innerHTML = `
                <div class="message-label">Assistant</div>
                <div class="message-content">
                    <div class="progress-container">
                        <div class="progress-header">
                            <div class="progress-spinner"></div>
                            <span class="progress-step">Working</span>
                        </div>
                        <div class="progress-message">Starting analysis...</div>
                        <div class="progress-detail" style="display: none;"></div>
                        <div class="queries-progress"></div>
                        <div class="progress-steps">
                            <div class="progress-step-dot active"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                            <div class="progress-step-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            return loadingId;
        }

        function removeLoading(loadingId) {
            const loading = document.getElementById(loadingId);
            if (loading) loading.remove();
        }

        function toggleQuery(header) {
            const content = header.nextElementSibling;
            content.style.display = content.style.display === 'none' ? 'block' : 'none';
        }

        function formatQueryResults(result) {
            if (!result.success) return `<div style="color: var(--accent-error);">Error: ${result.error}</div>`;
            if (!result.rows || result.rows.length === 0) return '<div class="empty-state">No results</div>';

            const columns = result.columns;
            const rows = result.rows.slice(0, 20);

            let html = '<table><thead><tr>';
            columns.forEach(col => { html += `<th>${escapeHtml(col)}</th>`; });
            html += '</tr></thead><tbody>';

            rows.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    const val = row[col] !== null ? String(row[col]) : '';
                    html += `<td title="${escapeHtml(val)}">${escapeHtml(val)}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            if (result.rows.length > 20) html += `<div class="empty-state">Showing 20 of ${result.rows.length} rows</div>`;
            return html;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            text = escapeHtml(text);

            // Code blocks first (preserve content)
            text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Headers
            text = text.replace(/^### (.*$)/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.*$)/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.*$)/gm, '<h1>$1</h1>');

            // Bold
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Normalize multiple newlines between list items to single newline
            text = text.replace(/(\n[ \t]*[-*])/g, '\n$1');
            text = text.replace(/(\n[ \t]*\d+[\.\)])/g, '\n$1');

            // Lists - convert to temp markers, strip extra whitespace
            // Note: Using <oli>/<uli> tags instead of {{OLI}}/{{ULI}} to avoid Jinja2 conflicts
            text = text.replace(/^[ \t]*(\d+)[\.\)] (.*$)/gm, '<oli>$2</oli>');
            text = text.replace(/^[ \t]*[a-z][\.\)] (.*$)/gm, '<oli>$1</oli>');
            text = text.replace(/^[ \t]*[-*] (.*$)/gm, '<uli>$1</uli>');

            // Wrap consecutive list items (handling newlines between them)
            text = text.replace(/((?:<oli>.*?<\/oli>\n*)+)/g, '<ol>$1</ol>');
            text = text.replace(/((?:<uli>.*?<\/uli>\n*)+)/g, '<ul>$1</ul>');

            // Convert markers to actual tags
            text = text.replace(/<oli>/g, '<li>').replace(/<\/oli>/g, '</li>');
            text = text.replace(/<uli>/g, '<li>').replace(/<\/uli>/g, '</li>');

            // Clean whitespace inside lists
            text = text.replace(/<\/li>\s+<li>/g, '</li><li>');
            text = text.replace(/<\/li>\s+<\/ol>/g, '</li></ol>');
            text = text.replace(/<\/li>\s+<\/ul>/g, '</li></ul>');
            text = text.replace(/<ol>\s+<li>/g, '<ol><li>');
            text = text.replace(/<ul>\s+<li>/g, '<ul><li>');

            // Paragraphs - only outside of lists
            text = text.replace(/\n\n+/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            text = '<p>' + text + '</p>';

            // Clean up
            text = text.replace(/<p><\/p>/g, '');
            text = text.replace(/<p>(<h[123]>)/g, '$1');
            text = text.replace(/(<\/h[123]>)<\/p>/g, '$1');
            text = text.replace(/<p>(<[ou]l>)/g, '$1');
            text = text.replace(/(<\/[ou]l>)<\/p>/g, '$1');
            text = text.replace(/<p>(<pre>)/g, '$1');
            text = text.replace(/(<\/pre>)<\/p>/g, '$1');
            text = text.replace(/<p>\s*<\/p>/g, '');
            text = text.replace(/<br>\s*(<[ou]l>)/g, '$1');
            text = text.replace(/(<\/[ou]l>)\s*<br>/g, '$1');
            text = text.replace(/<p><br>/g, '<p>');
            text = text.replace(/<br><\/p>/g, '</p>');

            // Highlight questions to the user (paragraphs ending with ?)
            // This helps differentiate agent questions from informational content
            text = text.replace(/<p>([^<]*\?)<\/p>/g, '<p class="agent-question">$1</p>');

            return text;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function clearChat() {
            await fetch('/api/clear', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: sessionId })
            });

            chatCharts.forEach(chart => chart.destroy());
            chatCharts = [];

            const container = document.getElementById('chat-container');
            container.innerHTML = `
                <div class="message assistant">
                    <div class="message-label">Assistant</div>
                    <div class="message-content">
                        <p>Chat cleared. How can I help you investigate issues?</p>
                    </div>
                </div>
            `;
        }

        async function refreshStatus() {
            try {
                // Get selected time window for services
                const timeSelector = document.getElementById('services-time-selector');
                const timeWindow = timeSelector ? timeSelector.value : '5m';

                const response = await fetch(`/api/status?time=${timeWindow}`);
                const data = await response.json();

                // Data-driven entity sidebar rendering
                if (data.entity_categories) {
                    const sectionsContainer = document.getElementById('entity-sections');
                    // Preserve time selector value
                    const oldTimeSelector = document.getElementById('services-time-selector');
                    const savedTimeValue = oldTimeSelector ? oldTimeSelector.value : '1h';

                    let sectionsHtml = '';
                    data.entity_categories.forEach(cat => {
                        const renderer = ENTITY_CONFIG[cat.type]?.sidebarRenderer || 'renderGenericItem';
                        const entities = cat.entities || [];
                        const nameField = cat.name_field;

                        // Store entity names for dropdowns
                        const sorted = [...entities].sort((a, b) =>
                            (a[nameField] || '').localeCompare(b[nameField] || '')
                        );
                        availableEntities[cat.type] = sorted.map(e => e[nameField]);
                        // Legacy compat
                        if (cat.type === 'service') availableServices = availableEntities[cat.type];
                        if (cat.type === 'database') availableDatabases = availableEntities[cat.type];

                        let headerExtra = '';
                        if (cat.type === 'service') {
                            headerExtra = `<select class="time-selector" id="services-time-selector" onchange="refreshStatus()">
                                <option value="1m" ${savedTimeValue==='1m'?'selected':''}>1m</option>
                                <option value="5m" ${savedTimeValue==='5m'?'selected':''}>5m</option>
                                <option value="15m" ${savedTimeValue==='15m'?'selected':''}>15m</option>
                                <option value="1h" ${savedTimeValue==='1h'?'selected':''}>1h</option>
                            </select>`;
                        }

                        let subtitle = 'Click to drill down';
                        if (cat.type === 'host') subtitle = 'System resources';

                        let itemsHtml = '';
                        if (sorted.length > 0) {
                            itemsHtml = sorted.map(e => window[renderer](e, cat.type, nameField)).join('');
                        } else {
                            const emptyMsg = cat.type === 'database' ? '<div class="empty-state" style="color: var(--accent-error);">No database spans!</div>' :
                                             `<div class="empty-state">No ${cat.display_name.toLowerCase()} data</div>`;
                            itemsHtml = emptyMsg;
                        }

                        sectionsHtml += `
                            <div class="sidebar-section">
                                <div class="section-header">
                                    <span class="section-title">${escapeHtml(cat.display_name)}</span>
                                    ${headerExtra}
                                </div>
                                <div class="status-card">
                                    <div class="status-card-title">${subtitle}</div>
                                    <div id="${cat.type}s-list">${itemsHtml}</div>
                                </div>
                            </div>
                        `;
                    });
                    sectionsContainer.innerHTML = sectionsHtml;
                } else {
                    // Fallback: render legacy way
                    const servicesList = document.getElementById('services-list');
                    if (data.services && data.services.length > 0) {
                        const sortedServices = [...data.services].sort((a, b) =>
                            a.service_name.localeCompare(b.service_name)
                        );
                        availableServices = sortedServices.map(s => s.service_name);
                        servicesList.innerHTML = sortedServices.map(s => renderServiceItem(s, 'service', 'service_name')).join('');
                    } else {
                        availableServices = [];
                        servicesList.innerHTML = '<div class="empty-state">No service data</div>';
                    }

                    const dbList = document.getElementById('databases-list');
                    if (data.databases && data.databases.length > 0) {
                        const sortedDbs = [...data.databases].sort((a, b) =>
                            a.db_system.localeCompare(b.db_system)
                        );
                        availableDatabases = sortedDbs.map(db => db.db_system);
                        dbList.innerHTML = sortedDbs.map(db => renderDatabaseItem(db, 'database', 'db_system')).join('');
                    } else {
                        availableDatabases = [];
                        dbList.innerHTML = '<div class="empty-state" style="color: var(--accent-error);">No database spans!</div>';
                    }

                    const hostsList = document.getElementById('hosts-list');
                    if (data.hosts && data.hosts.length > 0) {
                        hostsList.innerHTML = data.hosts.map(h => renderHostItem(h, 'host', 'host_name')).join('');
                    } else {
                        hostsList.innerHTML = '<div class="empty-state">No host metrics</div>';
                    }
                }

                // Error summary card with history buffer
                const errorSummary = document.getElementById('error-summary');
                const errorsList = document.getElementById('errors-list');
                const totalErrors = data.error_summary?.total_errors || 0;
                const affectedServices = data.error_summary?.affected_services || 0;

                // Merge new errors into history
                if (data.recent_errors && data.recent_errors.length > 0) {
                    data.recent_errors.forEach(e => {
                        const key = e.trace_id + '_' + e.span_id;
                        if (!errorHistory.has(key)) {
                            e._added_at = Date.now();
                            errorHistory.set(key, e);
                        }
                    });
                    // Trim history
                    if (errorHistory.size > MAX_HISTORY) {
                        const sorted = [...errorHistory.entries()].sort((a, b) => (b[1]._added_at || 0) - (a[1]._added_at || 0));
                        errorHistory.clear();
                        sorted.slice(0, MAX_HISTORY).forEach(([k, v]) => errorHistory.set(k, v));
                    }
                }

                if (totalErrors > 0 || errorHistory.size > 0) {
                    const displayCount = Math.max(totalErrors, errorHistory.size);
                    errorSummary.className = 'error-summary-card has-errors';
                    errorSummary.innerHTML = `
                        <div class="error-summary-stats">
                            <div>
                                <div class="error-count">${displayCount}</div>
                                <div class="error-label">errors${totalErrors > 0 ? ' (5m)' : ' (history)'}</div>
                            </div>
                            <div class="error-services">
                                <div class="error-services-count">${affectedServices}</div>
                                <div class="error-label">services</div>
                            </div>
                        </div>
                        <div class="expand-hint">Click to ${errorsList.classList.contains('errors-list-expanded') ? 'collapse' : 'expand'}</div>
                    `;
                    errorSummary.onclick = toggleErrorsList;

                    // Render errors from history (newest first)
                    const historyErrors = [...errorHistory.values()].sort((a, b) => (b._added_at || 0) - (a._added_at || 0));
                    // Mark which errors are still in the current response
                    const currentErrorKeys = new Set((data.recent_errors || []).map(e => e.trace_id + '_' + e.span_id));
                    errorsList.innerHTML = historyErrors.map(e => {
                        const key = e.trace_id + '_' + e.span_id;
                        const isCurrent = currentErrorKeys.has(key);
                        return `
                            <div class="error-item" style="${!isCurrent ? 'opacity: 0.5;' : ''}" onclick="event.stopPropagation(); openErrorModal('${e.trace_id}', '${e.span_id}')">
                                <div class="error-service">${e.service_name}</div>
                                <div class="error-span">${e.span_name}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    errorSummary.className = 'error-summary-card no-errors';
                    errorSummary.innerHTML = `
                        <div class="error-summary-stats">
                            <div>
                                <div class="error-count zero">0</div>
                                <div class="error-label">errors (5m)</div>
                            </div>
                        </div>
                    `;
                    errorSummary.onclick = null;
                    errorsList.innerHTML = '';
                    errorsList.className = 'errors-list-collapsed';
                }

                document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

                // Refresh combined alerts and background jobs
                await refreshAlerts();
                await refreshJobs();

            } catch (error) {
                console.error('Failed to refresh status:', error);
            }
        }

        async function refreshAlerts() {
            try {
                // Fetch all three sources in parallel
                const [alertsResp, activityResp, predictionsResp] = await Promise.all([
                    fetch('/api/alerts?status=all&limit=50'),
                    fetch('/api/alerts/activity?minutes=60&limit=50'),
                    fetch('/api/predictions')
                ]);
                const [alertsData, activityData, predictionsData] = await Promise.all([
                    alertsResp.json(), activityResp.json(), predictionsResp.json()
                ]);

                const alertsBadge = document.getElementById('alerts-badge');
                const container = document.getElementById('combined-alerts-list');

                // Merge alerts into alertHistory
                window.alertsCache = window.alertsCache || {};
                if (alertsData.alerts) {
                    alertsData.alerts.forEach(alert => {
                        window.alertsCache[alert.alert_id] = alert;
                        const existing = alertHistory.get(alert.alert_id);
                        if (existing) {
                            Object.assign(existing, alert);
                        } else {
                            alert._added_at = Date.now();
                            alertHistory.set(alert.alert_id, alert);
                        }
                    });
                }

                // Merge predictions into forecastHistory
                const predictions = predictionsData.predictions || [];
                predictions.forEach(p => {
                    const key = p.prediction_id || (p.host_name + '_' + p.resource_type);
                    const existing = forecastHistory.get(key);
                    if (existing) {
                        Object.assign(existing, p);
                    } else {
                        p._added_at = Date.now();
                        forecastHistory.set(key, p);
                    }
                });
                // Remove forecasts no longer active
                const activeForecastKeys = new Set(predictions.map(p => p.prediction_id || (p.host_name + '_' + p.resource_type)));
                for (const [k, v] of forecastHistory) {
                    if (!activeForecastKeys.has(k)) {
                        v.status = 'resolved';
                    }
                }

                // Trim histories
                if (alertHistory.size > MAX_HISTORY) {
                    const sorted = [...alertHistory.entries()].sort((a, b) => (b[1]._added_at || 0) - (a[1]._added_at || 0));
                    alertHistory.clear();
                    sorted.slice(0, MAX_HISTORY).forEach(([k, v]) => alertHistory.set(k, v));
                }
                if (forecastHistory.size > MAX_HISTORY) {
                    const sorted = [...forecastHistory.entries()].sort((a, b) => (b[1]._added_at || 0) - (a[1]._added_at || 0));
                    forecastHistory.clear();
                    sorted.slice(0, MAX_HISTORY).forEach(([k, v]) => forecastHistory.set(k, v));
                }

                // Separate active alerts, active forecasts, resolved/activity
                const severityOrder = { critical: 0, warning: 1, info: 2 };
                const activeAlerts = [...alertHistory.values()]
                    .filter(a => a.status === 'active')
                    .sort((a, b) => (severityOrder[a.severity] ?? 3) - (severityOrder[b.severity] ?? 3) || new Date(b.created_at || 0) - new Date(a.created_at || 0));

                const activeForecasts = [...forecastHistory.values()]
                    .filter(p => p.status === 'active')
                    .sort((a, b) => (a.hours_until_exhaustion || 999) - (b.hours_until_exhaustion || 999));

                const resolvedAlerts = [...alertHistory.values()]
                    .filter(a => a.status !== 'active')
                    .sort((a, b) => new Date(b.updated_at || b.created_at || 0) - new Date(a.updated_at || a.created_at || 0))
                    .slice(0, 10);

                // Activity events (rendered inline)
                const activityEvents = (activityData.events || []).slice(0, 10);

                // Update badge
                const activeCount = activeAlerts.length + activeForecasts.length;
                if (activeCount > 0) {
                    alertsBadge.textContent = activeCount;
                    alertsBadge.style.display = 'inline';
                    if (activeAlerts.some(a => a.severity === 'critical')) {
                        alertsBadge.style.background = 'var(--accent-error)';
                    } else if (activeAlerts.some(a => a.severity === 'warning')) {
                        alertsBadge.style.background = 'var(--accent-warning)';
                    } else {
                        alertsBadge.style.background = 'var(--accent-primary)';
                    }
                } else {
                    alertsBadge.style.display = 'none';
                }

                // Render combined list
                let html = '';

                // Active alerts
                activeAlerts.forEach(alert => {
                    const severity = alert.severity || 'info';
                    const timeAgo = formatTimeAgo(alert.created_at);
                    const hasInvestigation = alert.root_cause_summary;
                    const isRootCause = isRootCauseAlertType(alert.alert_type);
                    const categoryLabel = isRootCause ? 'ROOT CAUSE' : 'SYMPTOM';
                    const categoryClass = isRootCause ? 'root-cause' : 'symptom';

                    html += `
                        <div class="alert-item alert-${severity}" onclick="investigateAlert('${escapeHtml(alert.alert_id)}')">
                            <div class="alert-header">
                                <span class="alert-severity ${severity}">${severity}</span>
                                <span class="alert-type-badge severity-${severity}">${severity}</span>
                                <span class="alert-category ${categoryClass}">${categoryLabel}</span>
                                <span class="alert-time">${timeAgo}${hasInvestigation ? ' \u2022 analyzed' : ''}</span>
                            </div>
                            <div class="alert-title">${escapeHtml(alert.title || alert.alert_type)}</div>
                            ${hasInvestigation
                                ? `<div class="alert-root-cause">${escapeHtml(alert.root_cause_summary)}</div>`
                                : `<div class="alert-description">${escapeHtml(alert.description || '')}</div>`
                            }
                        </div>
                    `;
                });

                // Active forecasts
                const resourceIcons = { disk: '\u{1F4BE}', memory: '\u{1F9E0}', cpu: '\u{2699}\u{FE0F}', connections: '\u{1F50C}' };
                activeForecasts.forEach(p => {
                    const icon = resourceIcons[p.resource_type] || '\u{1F4CA}';
                    const hours = typeof p.hours_until_exhaustion === 'number' ? p.hours_until_exhaustion.toFixed(1) : '?';
                    const current = typeof p.current_value === 'number' ? Math.round(p.current_value * 100) : '?';

                    html += `
                        <div class="alert-item alert-forecast">
                            <div class="alert-header">
                                <span class="alert-type-badge badge-forecast">forecast</span>
                                <span class="alert-time">~${hours}h until threshold</span>
                            </div>
                            <div class="alert-title">${icon} ${escapeHtml(p.resource_type)} - ${escapeHtml(p.host_name || p.service_name || '')}</div>
                            <div class="alert-description">Currently ${current}% &rarr; exhaustion in ~${hours}h</div>
                        </div>
                    `;
                });

                // Activity events (inline status changes)
                activityEvents.forEach(event => {
                    const eventType = event.event_type;
                    const timeAgo = formatTimeAgo(event.event_time);
                    const service = escapeHtml(event.service_name || 'unknown');
                    const alertType = (event.alert_type || '').replace(/_/g, ' ');

                    let label;
                    if (eventType === 'created') {
                        label = 'alert created';
                    } else if (eventType === 'auto_resolved') {
                        label = 'auto-resolved';
                    } else {
                        label = 'resolved';
                    }

                    html += `
                        <div class="alert-item resolved" style="padding: 6px 12px;">
                            <div class="alert-header">
                                <span class="alert-type-badge badge-activity">${eventType}</span>
                                <span class="alert-time">${timeAgo}</span>
                            </div>
                            <div class="alert-description">${service} \u2014 ${alertType} ${label}</div>
                        </div>
                    `;
                });

                // Resolved alerts
                resolvedAlerts.forEach(alert => {
                    const severity = alert.severity || 'info';
                    const timeAgo = formatTimeAgo(alert.updated_at || alert.created_at);

                    html += `
                        <div class="alert-item alert-${severity} resolved" onclick="investigateAlert('${escapeHtml(alert.alert_id)}')">
                            <div class="alert-header">
                                <span class="alert-type-badge badge-resolved">resolved</span>
                                <span class="alert-time">${timeAgo}</span>
                            </div>
                            <div class="alert-title">${escapeHtml(alert.title || alert.alert_type)}</div>
                        </div>
                    `;
                });

                container.innerHTML = html || '<div class="empty-state" style="color: var(--accent-success);">No alerts</div>';

            } catch (error) {
                console.error('Failed to refresh alerts:', error);
                document.getElementById('combined-alerts-list').innerHTML = '<div class="empty-state">Alerts unavailable</div>';
            }
        }

        // Root cause alert types - these indicate underlying issues that can lead to symptoms
        const ROOT_CAUSE_ALERT_TYPES = [
            'db_connection_failure',
            'db_slow_queries',
            'dependency_failure',
            'dependency_latency',
            'exception_surge',
            'new_exception_type'
        ];

        function isRootCauseAlertType(alertType) {
            return ROOT_CAUSE_ALERT_TYPES.includes(alertType);
        }

        function formatTimeAgo(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours}h ago`;
            return `${Math.floor(diffHours / 24)}d ago`;
        }

        function investigateAlert(alertId) {
            // Look up alert from cache and open modal
            const alert = window.alertsCache ? window.alertsCache[alertId] : null;
            openAlertModal(alert, alertId);
        }

        function openAlertModal(alert, alertId) {
            const modal = document.getElementById('alert-modal');
            const content = document.getElementById('alert-modal-content');

            if (!alert) {
                content.innerHTML = `
                    <div class="alert-no-investigation">
                        <div class="alert-no-investigation-icon"></div>
                        <div class="alert-no-investigation-text">Alert not found in cache</div>
                        <button class="alert-action-btn primary" onclick="askAboutAlert('${alertId}')">
                            Investigate via Chat
                        </button>
                    </div>
                `;
                modal.classList.add('active');
                return;
            }

            const severity = alert.severity || 'info';
            const alertType = (alert.alert_type || '').replace(/_/g, ' ');
            const hasInvestigation = alert.root_cause_summary;
            const createdAt = alert.created_at ? new Date(alert.created_at).toLocaleString() : 'Unknown';
            const isRootCause = isRootCauseAlertType(alert.alert_type);
            const categoryLabel = isRootCause ? 'ROOT CAUSE' : 'SYMPTOM';
            const categoryClass = isRootCause ? 'root-cause' : 'symptom';

            let investigationHtml;
            if (hasInvestigation) {
                investigationHtml = `
                    <div class="alert-section">
                        <div class="alert-section-title"> Root Cause</div>
                        <div class="alert-section-content root-cause">
                            ${escapeHtml(alert.root_cause_summary)}
                        </div>
                    </div>

                    ${alert.recommended_actions ? `
                    <div class="alert-section">
                        <div class="alert-section-title"> Recommended Actions</div>
                        <div class="alert-section-content actions">
                            ${escapeHtml(alert.recommended_actions).replace(/\n/g, '<br>')}
                        </div>
                    </div>
                    ` : ''}

                    ${alert.supporting_evidence ? `
                    <div class="alert-section">
                        <div class="alert-section-title"> Supporting Evidence</div>
                        <div class="alert-section-content evidence">
${escapeHtml(alert.supporting_evidence)}</div>
                    </div>
                    ` : ''}

                    <div class="alert-investigation-stats">
                        ${alert.queries_executed ? `<span> ${alert.queries_executed} queries</span>` : ''}
                        ${alert.tokens_used ? `<span> ${alert.tokens_used} tokens</span>` : ''}
                        ${alert.model_used ? `<span> ${alert.model_used}</span>` : ''}
                    </div>
                `;
            } else {
                // Determine why no investigation exists
                const isNonCritical = severity !== 'critical';
                const criticalOnlyMode = alertsConfig.investigate_critical_only;

                let noInvestigationReason;
                if (criticalOnlyMode && isNonCritical) {
                    noInvestigationReason = `Auto-investigation is configured for <strong>critical alerts only</strong>.<br>
                        This ${severity} alert was not automatically investigated.`;
                } else {
                    noInvestigationReason = `No investigation available yet.<br>
                        The automated system may be rate-limited or processing other alerts.`;
                }

                investigationHtml = `
                    <div class="alert-no-investigation">
                        <div class="alert-no-investigation-icon"></div>
                        <div class="alert-no-investigation-text">
                            ${noInvestigationReason}
                        </div>
                        <button class="alert-action-btn primary" onclick="requestInvestigation('${escapeHtml(alert.alert_id)}')" id="investigate-btn-${escapeHtml(alert.alert_id)}">
                            Request Investigation
                        </button>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="alert-detail-header">
                    <span class="alert-detail-severity ${severity}">${severity}</span>
                    <span class="alert-category ${categoryClass}" style="margin-left: 8px;">${categoryLabel}</span>
                    <span class="alert-detail-title">${escapeHtml(alert.title || alertType)}</span>
                </div>

                <div class="alert-detail-meta">
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Alert ID</span>
                        <span class="alert-meta-value" style="font-family: 'JetBrains Mono', monospace; font-size: 11px;">${escapeHtml(alert.alert_id)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Service</span>
                        <span class="alert-meta-value">${escapeHtml(alert.service_name)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Category</span>
                        <span class="alert-meta-value">${isRootCause ? 'Root Cause (proactive)' : 'Symptom (reactive)'}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Type</span>
                        <span class="alert-meta-value">${escapeHtml(alertType)}</span>
                    </div>
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Created</span>
                        <span class="alert-meta-value">${createdAt}</span>
                    </div>
                    ${alert.current_value ? `
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Current Value</span>
                        <span class="alert-meta-value">${typeof alert.current_value === 'number' ? alert.current_value.toFixed(2) : alert.current_value}</span>
                    </div>
                    ` : ''}
                    ${alert.baseline_value ? `
                    <div class="alert-meta-item">
                        <span class="alert-meta-label">Baseline</span>
                        <span class="alert-meta-value">${typeof alert.baseline_value === 'number' ? alert.baseline_value.toFixed(2) : alert.baseline_value}</span>
                    </div>
                    ` : ''}
                </div>

                ${alert.description ? `
                <div class="alert-section">
                    <div class="alert-section-title"> Description</div>
                    <div class="alert-section-content">
                        ${escapeHtml(alert.description)}
                    </div>
                </div>
                ` : ''}

                ${investigationHtml}

                <div class="alert-actions">
                    <button class="alert-action-btn secondary" onclick="closeAlertModal()">Close</button>
                    <button class="alert-action-btn warning" onclick="archiveAlert('${escapeHtml(alert.alert_id)}')">Archive</button>
                    <button class="alert-action-btn primary" onclick="askAboutAlert('${escapeHtml(alert.alert_id)}', '${escapeHtml(alert.service_name)}', '${escapeHtml(alertType)}', ${hasInvestigation ? 'true' : 'false'})">
                        ${hasInvestigation ? 'Ask Follow-up' : 'Investigate in Chat'}
                    </button>
                </div>
            `;

            modal.classList.add('active');
        }

        function closeAlertModal() {
            document.getElementById('alert-modal').classList.remove('active');
        }

        async function requestInvestigation(alertId) {
            const btn = document.getElementById(`investigate-btn-${alertId}`);
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Investigating...';
            }

            try {
                const response = await fetch(`/api/alerts/${alertId}/investigate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    // Update the cache with investigation results
                    if (window.alertsCache && window.alertsCache[alertId]) {
                        Object.assign(window.alertsCache[alertId], data.investigation);
                    }
                    // Refresh the modal to show results
                    const alert = window.alertsCache ? window.alertsCache[alertId] : null;
                    openAlertModal(alert, alertId);
                    // Refresh alerts list too
                    refreshAlerts();
                } else {
                    if (btn) {
                        btn.textContent = data.error || 'Failed';
                        btn.disabled = false;
                        setTimeout(() => {
                            btn.textContent = 'Request Investigation';
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Investigation request failed:', error);
                if (btn) {
                    btn.textContent = 'Error - Try Again';
                    btn.disabled = false;
                    setTimeout(() => {
                        btn.textContent = 'Request Investigation';
                    }, 3000);
                }
            }
        }

        async function archiveAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/archive`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.success) {
                    closeAlertModal();
                    // Remove from cache and refresh
                    if (window.alertsCache) {
                        delete window.alertsCache[alertId];
                    }
                    alertHistory.delete(alertId);
                    refreshAlerts();
                } else {
                    alert('Failed to archive: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Archive failed:', error);
                alert('Failed to archive alert');
            }
        }

        function askAboutAlert(alertId, serviceName, alertType, hasInvestigation) {
            closeAlertModal();
            const alert = window.alertsCache ? window.alertsCache[alertId] : null;

            let prompt;
            if (hasInvestigation && alert) {
                prompt = `I'm looking at a ${alertType} alert for ${serviceName}.

**Automated Analysis Found:**
${alert.root_cause_summary}

${alert.recommended_actions ? `**Recommended Actions:**
${alert.recommended_actions}` : ''}

Can you help me understand this issue further or suggest next steps?`;
            } else {
                prompt = `Investigate the ${alertType || 'alert'} for ${serviceName || 'this service'}. What's causing this issue?`;
            }

            setPrompt(prompt);
            sendMessage();
        }

        async function refreshJobs() {
            try {
                const response = await fetch('/api/jobs/status');
                const data = await response.json();
                const jobsList = document.getElementById('jobs-list');

                const jobNames = {
                    'metric_aggregator': 'Metric Aggregator',
                    'topology_inference': 'Topology Inference',
                    'predictive_alerts': 'Predictive Alerts'
                };

                if (data.jobs && data.jobs.length > 0) {
                    jobsList.innerHTML = data.jobs.map(job => {
                        const name = jobNames[job.job_name] || job.job_name;
                        const durationS = job.cycle_duration_ms ? (job.cycle_duration_ms / 1000).toFixed(1) : '?';

                        // Calculate staleness
                        let staleClass = '';
                        let agoText = '';
                        if (job.updated_at) {
                            const updatedAt = new Date(job.updated_at);
                            const agoMs = Date.now() - updatedAt.getTime();
                            const agoS = Math.floor(agoMs / 1000);
                            if (agoS < 60) agoText = agoS + 's ago';
                            else if (agoS < 3600) agoText = Math.floor(agoS / 60) + 'm ago';
                            else agoText = Math.floor(agoS / 3600) + 'h ago';

                            if (agoMs > 180000) staleClass = 'job-stale'; // > 3 min
                        }
                        if (job.status === 'error') staleClass = 'job-error';

                        // Details line
                        let detailLine = '';
                        if (job.details) {
                            if (job.details.active_alerts !== undefined) {
                                detailLine = `Active alerts: ${job.details.active_alerts}`;
                            }
                            if (job.details.error) {
                                detailLine = job.details.error;
                            }
                        }

                        return `
                            <div class="job-item ${staleClass}">
                                <div class="job-indicator"></div>
                                <div class="job-info">
                                    <div class="job-name">${escapeHtml(name)}</div>
                                    <div class="job-details">Last run: ${agoText || 'never'} (took ${durationS}s)${detailLine ? ' \u2022 ' + escapeHtml(detailLine) : ''}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    jobsList.innerHTML = '<div class="empty-state">No job data</div>';
                }
            } catch (error) {
                console.error('Failed to refresh jobs:', error);
                document.getElementById('jobs-list').innerHTML = '<div class="empty-state">Jobs unavailable</div>';
            }
        }

        // =================================================================
        // Generic Entity Modal Functions
        // =================================================================

        async function openEntityModal(type, name) {
            const config = ENTITY_CONFIG[type];
            if (!config) { console.error('Unknown entity type:', type); return; }

            currentEntityType = type;
            currentEntityName = name;
            // Legacy compat
            if (type === 'service') currentModalService = name;
            if (type === 'database') currentModalDatabase = name;
            if (type === 'host') currentModalHost = name;

            const modal = document.getElementById('entity-modal');
            modal.classList.add('active');

            // Set badge
            const badge = document.getElementById('entity-type-badge');
            badge.textContent = config.displayName;
            badge.className = `modal-type-badge ${config.badgeClass || ''}`;
            if (type === 'host') {
                badge.style.background = 'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)';
            } else if (type === 'container') {
                badge.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            } else {
                badge.style.background = '';
            }

            // Populate selector
            const selector = document.getElementById('entity-selector');
            const entities = availableEntities[type] || [];
            if (type === 'host' || type === 'container') {
                // Host/container uses a title instead of dropdown
                selector.innerHTML = `<option value="${escapeHtml(name)}" selected>${escapeHtml(name)}</option>`;
            } else {
                selector.innerHTML = entities.map(e =>
                    `<option value="${escapeHtml(e)}" ${e === name ? 'selected' : ''}>${escapeHtml(e)}</option>`
                ).join('');
            }

            // Build tabs
            const tabsContainer = document.getElementById('entity-modal-tabs');
            tabsContainer.innerHTML = config.tabs.map((tab, i) => {
                const activeClass = tab.id === config.defaultTab ? ' active' : '';
                const badge = tab.hasBadge ? ` <span class="tab-badge" id="entity-${tab.id}-count">-</span>` : '';
                return `<div class="modal-tab${activeClass}" onclick="switchEntityTab('${tab.id}')">${tab.label}${badge}</div>`;
            }).join('');

            // Enable auto-refresh
            entityModalAutoRefresh = true;
            document.getElementById('entity-modal-auto-toggle').classList.add('active');
            const indicator = document.getElementById('entity-modal-auto-indicator');
            indicator.classList.add('active');
            indicator.querySelector('span:last-child').textContent = 'Auto-refresh on';

            // Load default tab
            await switchEntityTab(config.defaultTab);
            startEntityModalAutoRefresh();
        }

        function switchEntity(name) {
            if (name && name !== currentEntityName) {
                const type = currentEntityType;
                currentEntityName = name;
                if (type === 'service') currentModalService = name;
                if (type === 'database') currentModalDatabase = name;
                if (type === 'host') currentModalHost = name;
                const config = ENTITY_CONFIG[type];
                switchEntityTab(config.defaultTab);
            }
        }

        async function switchEntityTab(tabId) {
            if (!currentEntityType) return;
            const config = ENTITY_CONFIG[currentEntityType];

            // Update tab active state
            document.querySelectorAll('#entity-modal-tabs .modal-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const activeTab = document.querySelector(`#entity-modal-tabs .modal-tab[onclick*="${tabId}"]`);
            if (activeTab) activeTab.classList.add('active');

            // Find tab config and call loader
            const tabConfig = config.tabs.find(t => t.id === tabId);
            if (tabConfig && window[tabConfig.loader]) {
                await window[tabConfig.loader]();
            }
        }

        function closeEntityModal() {
            document.getElementById('entity-modal').classList.remove('active');
            stopEntityModalAutoRefresh();
            currentEntityType = null;
            currentEntityName = null;
            currentModalService = null;
            currentModalDatabase = null;
            currentModalHost = null;
            entityModalAutoRefresh = false;
        }

        function toggleEntityModalAutoRefresh() {
            entityModalAutoRefresh = !entityModalAutoRefresh;
            const toggle = document.getElementById('entity-modal-auto-toggle');
            const indicator = document.getElementById('entity-modal-auto-indicator');
            toggle.classList.toggle('active', entityModalAutoRefresh);
            indicator.classList.toggle('active', entityModalAutoRefresh);
            indicator.querySelector('span:last-child').textContent = entityModalAutoRefresh ? 'Auto-refresh on' : 'Auto-refresh off';
            if (entityModalAutoRefresh && currentEntityName) {
                startEntityModalAutoRefresh();
            } else {
                stopEntityModalAutoRefresh();
            }
        }

        function startEntityModalAutoRefresh() {
            if (entityModalRefreshInterval) clearInterval(entityModalRefreshInterval);
            if (entityModalAutoRefresh && currentEntityName) {
                entityModalRefreshInterval = setInterval(() => refreshEntityModal(), MODAL_REFRESH_INTERVAL);
            }
        }

        function stopEntityModalAutoRefresh() {
            if (entityModalRefreshInterval) {
                clearInterval(entityModalRefreshInterval);
                entityModalRefreshInterval = null;
            }
        }

        async function refreshEntityModal() {
            if (!currentEntityType || !currentEntityName) return;
            const btn = document.getElementById('entity-modal-refresh-btn');
            btn.classList.add('spinning');
            // Re-run the currently active tab's loader
            const config = ENTITY_CONFIG[currentEntityType];
            const activeTabEl = document.querySelector('#entity-modal-tabs .modal-tab.active');
            if (activeTabEl) {
                const match = activeTabEl.getAttribute('onclick')?.match(/switchEntityTab\('([^']+)'\)/);
                if (match) {
                    const tabConfig = config.tabs.find(t => t.id === match[1]);
                    if (tabConfig && window[tabConfig.loader]) await window[tabConfig.loader]();
                }
            }
            btn.classList.remove('spinning');
        }

        // =================================================================
        // Generic Tab Content Loaders
        // =================================================================

        async function loadEntityCharts() {
            if (!currentEntityType || !currentEntityName) return;

            // On first load (no existing charts), build the HTML skeleton.
            // On refresh, skip the rebuild so charts update in-place.
            const hasCharts = Object.keys(modalCharts).length > 0;

            if (!hasCharts) {
                Object.values(modalCharts).forEach(chart => chart.destroy());
                modalCharts = {};
                const body = document.getElementById('entity-modal-body');

                if (currentEntityType === 'service') {
                    body.innerHTML = `
                        <div class="chart-row">
                            <div class="chart-card"><h4>Latency Over Time</h4><canvas id="entity-latency-chart"></canvas></div>
                            <div class="chart-card"><h4>Error Rate Over Time</h4><canvas id="entity-error-chart"></canvas></div>
                        </div>
                        <div class="chart-row">
                            <div class="chart-card"><h4>Request Volume</h4><canvas id="entity-throughput-chart"></canvas></div>
                            <div class="chart-card">
                                <div class="chart-card-header">
                                    <h4>Top Operations</h4>
                                    <select class="time-selector" id="ops-time-selector" onchange="refreshTopOperations()">
                                        <option value="10s">Last 10s</option><option value="30s">Last 30s</option>
                                        <option value="1m">Last 1m</option><option value="5m" selected>Last 5m</option>
                                        <option value="15m">Last 15m</option><option value="1h">Last 1h</option>
                                    </select>
                                </div>
                                <table class="ops-table" id="ops-table"><thead><tr><th>Operation</th><th>Calls</th><th>Avg Latency</th><th>Error %</th></tr></thead><tbody></tbody></table>
                            </div>
                        </div>
                    `;
                } else if (currentEntityType === 'database') {
                    body.innerHTML = `
                        <div class="chart-row">
                            <div class="chart-card"><h4>Query Latency Over Time</h4><canvas id="entity-latency-chart"></canvas></div>
                            <div class="chart-card"><h4>Query Volume Over Time</h4><canvas id="entity-volume-chart"></canvas></div>
                        </div>
                        <div class="chart-row">
                            <div class="chart-card"><h4>Error Rate Over Time</h4><canvas id="entity-error-chart"></canvas></div>
                            <div class="chart-card"><h4>Slowest Queries</h4>
                                <table class="ops-table" id="db-queries-table"><thead><tr><th>Service</th><th>Operation</th><th>Avg Latency</th><th>Error %</th></tr></thead><tbody></tbody></table>
                            </div>
                        </div>
                        <div class="chart-row">
                            <div class="chart-card"><h4>Deadlocks Over Time</h4><canvas id="entity-deadlocks-chart"></canvas></div>
                            <div class="chart-card"><h4>Database Size Over Time</h4><canvas id="entity-size-chart"></canvas></div>
                        </div>
                    `;
                }
            }

            // Load/refresh data (creates charts on first call, updates in-place on subsequent)
            if (currentEntityType === 'service') {
                await loadServiceChartsData();
            } else if (currentEntityType === 'database') {
                await loadDatabaseChartsData();
            }
        }

        function updateChartInPlace(chart, labels, datasets) {
            chart.data.labels = labels;
            datasets.forEach((ds, i) => {
                if (chart.data.datasets[i]) {
                    chart.data.datasets[i].data = ds.data;
                }
            });
            chart.update('none'); // skip animations for smoother refresh
        }

        async function loadServiceChartsData() {
            try {
                const response = await fetch(`/api/entity/service/${encodeURIComponent(currentEntityName)}?range=1`);
                const data = await response.json();

                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const avgData = data.latency_history.map(r => r.avg_latency_ms);
                    const maxData = data.latency_history.map(r => r.max_latency_ms);
                    const reqData = data.latency_history.map(r => r.request_count);

                    if (modalCharts.latency) {
                        updateChartInPlace(modalCharts.latency, labels, [{data: avgData}, {data: maxData}]);
                    } else {
                        modalCharts.latency = new Chart(document.getElementById('entity-latency-chart'), {
                            type: 'line', data: { labels, datasets: [
                                { label: 'Avg Latency (ms)', data: avgData, borderColor: '#00d9ff', tension: 0.4, fill: false, pointRadius: 2 },
                                { label: 'Max Latency (ms)', data: maxData, borderColor: '#ef4444', tension: 0.4, fill: false, pointRadius: 2 }
                            ]}, options: chartOptions()
                        });
                    }
                    if (modalCharts.throughput) {
                        updateChartInPlace(modalCharts.throughput, labels, [{data: reqData}]);
                    } else {
                        modalCharts.throughput = new Chart(document.getElementById('entity-throughput-chart'), {
                            type: 'bar', data: { labels, datasets: [
                                { label: 'Requests', data: reqData, backgroundColor: 'rgba(0,217,255,0.4)', borderColor: '#00d9ff', borderWidth: 1 }
                            ]}, options: chartOptions()
                        });
                    }
                }
                if (data.error_history && data.error_history.length > 0) {
                    const labels = data.error_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const errData = data.error_history.map(r => r.error_pct);

                    if (modalCharts.errors) {
                        updateChartInPlace(modalCharts.errors, labels, [{data: errData}]);
                    } else {
                        modalCharts.errors = new Chart(document.getElementById('entity-error-chart'), {
                            type: 'line', data: { labels, datasets: [
                                { label: 'Error %', data: errData, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                            ]}, options: chartOptions()
                        });
                    }
                }
            } catch (error) { console.error('Failed to load service charts:', error); }
            await refreshTopOperations();
        }

        async function refreshTopOperations() {
            if (!currentEntityName || currentEntityType !== 'service') return;
            const timeSelector = document.getElementById('ops-time-selector');
            const timeWindow = timeSelector ? timeSelector.value : '5m';
            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentEntityName)}/operations?time=${timeWindow}`);
                const data = await response.json();
                const opsTable = document.getElementById('ops-table')?.querySelector('tbody');
                if (!opsTable) return;
                if (data.operations && data.operations.length > 0) {
                    opsTable.innerHTML = data.operations.map(op => `
                        <tr><td title="${escapeHtml(op.span_name)}">${escapeHtml(op.span_name)}</td>
                        <td>${op.call_count}</td><td>${op.avg_latency_ms}ms</td>
                        <td style="color: ${op.error_pct > 5 ? 'var(--accent-error)' : 'inherit'}">${op.error_pct}%</td></tr>
                    `).join('');
                } else {
                    opsTable.innerHTML = '<tr><td colspan="4" class="empty-state">No data</td></tr>';
                }
            } catch (error) { console.error('Failed to load top operations:', error); }
        }

        async function loadDatabaseChartsData() {
            try {
                const response = await fetch(`/api/entity/database/${encodeURIComponent(currentEntityName)}?range=1`);
                const data = await response.json();

                if (data.latency_history && data.latency_history.length > 0) {
                    const labels = data.latency_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const avgData = data.latency_history.map(r => r.avg_latency_ms);
                    const maxData = data.latency_history.map(r => r.max_latency_ms);
                    const volData = data.latency_history.map(r => r.query_count);

                    if (modalCharts.latency) {
                        updateChartInPlace(modalCharts.latency, labels, [{data: avgData}, {data: maxData}]);
                    } else {
                        modalCharts.latency = new Chart(document.getElementById('entity-latency-chart'), {
                            type: 'line', data: { labels, datasets: [
                                { label: 'Avg Latency (ms)', data: avgData, borderColor: '#7c3aed', tension: 0.4, fill: false, pointRadius: 2 },
                                { label: 'Max Latency (ms)', data: maxData, borderColor: '#ef4444', tension: 0.4, fill: false, pointRadius: 2 }
                            ]}, options: chartOptions()
                        });
                    }
                    if (modalCharts.volume) {
                        updateChartInPlace(modalCharts.volume, labels, [{data: volData}]);
                    } else {
                        modalCharts.volume = new Chart(document.getElementById('entity-volume-chart'), {
                            type: 'bar', data: { labels, datasets: [
                                { label: 'Queries', data: volData, backgroundColor: 'rgba(124,58,237,0.4)', borderColor: '#7c3aed', borderWidth: 1 }
                            ]}, options: chartOptions()
                        });
                    }
                }
                if (data.error_history && data.error_history.length > 0) {
                    const labels = data.error_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const errData = data.error_history.map(r => r.error_pct);

                    if (modalCharts.errors) {
                        updateChartInPlace(modalCharts.errors, labels, [{data: errData}]);
                    } else {
                        modalCharts.errors = new Chart(document.getElementById('entity-error-chart'), {
                            type: 'line', data: { labels, datasets: [
                                { label: 'Error %', data: errData, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                            ]}, options: chartOptions()
                        });
                    }
                }
                const queriesTable = document.getElementById('db-queries-table')?.querySelector('tbody');
                if (queriesTable && data.slow_queries && data.slow_queries.length > 0) {
                    queriesTable.innerHTML = data.slow_queries.map(q => `
                        <tr><td title="${escapeHtml(q.service_name)}">${escapeHtml(q.service_name)}</td>
                        <td title="${escapeHtml(q.span_name)}">${escapeHtml(q.span_name)}</td>
                        <td>${q.avg_latency_ms}ms</td>
                        <td style="color: ${q.error_pct > 5 ? 'var(--accent-error)' : 'inherit'}">${q.error_pct}%</td></tr>
                    `).join('');
                } else if (queriesTable) {
                    queriesTable.innerHTML = '<tr><td colspan="4" class="empty-state">No data</td></tr>';
                }
                if (data.deadlock_history && data.deadlock_history.length > 0) {
                    const dlLabels = data.deadlock_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const dlData = data.deadlock_history.map(r => r.deadlock_count);

                    if (modalCharts.deadlocks) {
                        updateChartInPlace(modalCharts.deadlocks, dlLabels, [{data: dlData}]);
                    } else {
                        modalCharts.deadlocks = new Chart(document.getElementById('entity-deadlocks-chart'), {
                            type: 'bar', data: { labels: dlLabels, datasets: [
                                { label: 'Deadlocks', data: dlData, backgroundColor: 'rgba(239,68,68,0.4)', borderColor: '#ef4444', borderWidth: 1 }
                            ]}, options: chartOptions()
                        });
                    }
                }
                if (data.size_history && data.size_history.length > 0) {
                    const szLabels = data.size_history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                    const szData = data.size_history.map(r => r.size_mb);

                    if (modalCharts.dbSize) {
                        updateChartInPlace(modalCharts.dbSize, szLabels, [{data: szData}]);
                    } else {
                        modalCharts.dbSize = new Chart(document.getElementById('entity-size-chart'), {
                            type: 'line', data: { labels: szLabels, datasets: [
                                { label: 'Size (MB)', data: szData, borderColor: '#00d9ff', backgroundColor: 'rgba(0,217,255,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                            ]}, options: chartOptions()
                        });
                    }
                }
            } catch (error) { console.error('Failed to load database charts:', error); }
        }

        async function loadEntityOverview() {
            if (!currentEntityName) return;
            const body = document.getElementById('entity-modal-body');

            // Only rebuild HTML skeleton if charts don't exist yet (for in-place refresh)
            const hasHostCharts = modalCharts.hostCpu || modalCharts.hostMemory;
            if (!hasHostCharts) {
                // Destroy any leftover charts from a previous tab/entity
                Object.values(modalCharts).forEach(c => c.destroy());
                modalCharts = {};
                body.innerHTML = `
                    <div class="chart-row">
                        <div class="chart-card"><h4>Current Resource Usage</h4>
                            <div class="host-detail-metrics" id="host-current-metrics"><div class="empty-state">Loading...</div></div>
                        </div>
                        <div class="chart-card"><h4>Host Information</h4>
                            <div class="host-info" id="host-info"><div class="empty-state">Loading...</div></div>
                        </div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-card"><h4>CPU Over Time</h4><canvas id="host-cpu-history-chart"></canvas></div>
                        <div class="chart-card"><h4>Memory Over Time</h4><canvas id="host-memory-history-chart"></canvas></div>
                    </div>
                    <div class="chart-row">
                        <div class="chart-card"><h4>Disk Over Time</h4><canvas id="host-disk-history-chart"></canvas></div>
                        <div class="chart-card"></div>
                    </div>
                `;
            }
            await loadHostData(currentEntityName);
            await loadHostResourceHistory(currentEntityName);
        }

        async function loadHostResourceHistory(hostName) {
            try {
                const response = await fetch(`/api/host/${encodeURIComponent(hostName)}/resource-history`);
                const data = await response.json();
                if (!data.history || data.history.length === 0) return;

                const labels = data.history.map(r => new Date(r.time_bucket).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}));
                const cpuData = data.history.map(r => r.cpu_pct);
                const memData = data.history.map(r => r.memory_pct);
                const diskData = data.history.map(r => r.disk_pct);

                if (modalCharts.hostCpu) {
                    updateChartInPlace(modalCharts.hostCpu, labels, [{data: cpuData}]);
                } else {
                    modalCharts.hostCpu = new Chart(document.getElementById('host-cpu-history-chart'), {
                        type: 'line', data: { labels, datasets: [
                            { label: 'CPU %', data: cpuData, borderColor: '#00d9ff', backgroundColor: 'rgba(0,217,255,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                        ]}, options: chartOptions()
                    });
                }

                if (modalCharts.hostMemory) {
                    updateChartInPlace(modalCharts.hostMemory, labels, [{data: memData}]);
                } else {
                    modalCharts.hostMemory = new Chart(document.getElementById('host-memory-history-chart'), {
                        type: 'line', data: { labels, datasets: [
                            { label: 'Memory %', data: memData, borderColor: '#7c3aed', backgroundColor: 'rgba(124,58,237,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                        ]}, options: chartOptions()
                    });
                }

                if (modalCharts.hostDisk) {
                    updateChartInPlace(modalCharts.hostDisk, labels, [{data: diskData}]);
                } else {
                    modalCharts.hostDisk = new Chart(document.getElementById('host-disk-history-chart'), {
                        type: 'line', data: { labels, datasets: [
                            { label: 'Disk %', data: diskData, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, fill: true, pointRadius: 2 }
                        ]}, options: chartOptions()
                    });
                }
            } catch (error) { console.error('Failed to load host resource history:', error); }
        }

        async function loadContainerOverview() {
            if (!currentEntityName) return;
            const body = document.getElementById('entity-modal-body');
            body.innerHTML = `
                <div class="chart-row">
                    <div class="chart-card"><h4>Container Resource Usage</h4>
                        <div class="host-detail-metrics" id="container-current-metrics"><div class="empty-state">Loading...</div></div>
                    </div>
                </div>
            `;
            try {
                const response = await fetch(`/api/entity/container/${encodeURIComponent(currentEntityName)}/metrics?time=5m`);
                const data = await response.json();
                const metricsDiv = document.getElementById('container-current-metrics');
                if (data.success && data.rows && data.rows.length > 0) {
                    const metricsByName = {};
                    data.rows.forEach(r => { metricsByName[r.metric_name] = r; });
                    const cpu = metricsByName['container.cpu.percent'];
                    const memPct = metricsByName['container.memory.percent'];
                    const memUsage = metricsByName['container.memory.usage.total'];
                    const cpuVal = cpu ? cpu.latest_value?.toFixed(1) : '-';
                    const memPctVal = memPct ? memPct.latest_value?.toFixed(1) : '-';
                    const memMB = memUsage ? (memUsage.latest_value / 1048576.0).toFixed(1) : '-';
                    const cpuClass = cpuVal === '-' ? '' : (parseFloat(cpuVal) > 80 ? 'metric-error' : parseFloat(cpuVal) > 60 ? 'metric-warn' : 'metric-ok');
                    const memClass = memPctVal === '-' ? '' : (parseFloat(memPctVal) > 85 ? 'metric-error' : parseFloat(memPctVal) > 70 ? 'metric-warn' : 'metric-ok');
                    metricsDiv.innerHTML = `
                        <div class="host-metrics" style="justify-content: flex-start; gap: 32px;">
                            <div class="host-metric">
                                <div class="host-metric-value ${cpuClass}">${cpuVal}%</div>
                                <div class="host-metric-label">CPU</div>
                            </div>
                            <div class="host-metric">
                                <div class="host-metric-value ${memClass}">${memPctVal}%</div>
                                <div class="host-metric-label">MEM %</div>
                            </div>
                            <div class="host-metric">
                                <div class="host-metric-value">${memMB} MB</div>
                                <div class="host-metric-label">MEM Usage</div>
                            </div>
                        </div>
                    `;
                } else {
                    metricsDiv.innerHTML = '<div class="empty-state">No container metrics found</div>';
                }
            } catch (error) {
                console.error('Failed to load container overview:', error);
                document.getElementById('container-current-metrics').innerHTML = '<div class="empty-state">Failed to load metrics</div>';
            }
        }

        async function loadEntityServices() {
            if (!currentEntityName) return;
            const body = document.getElementById('entity-modal-body');
            body.innerHTML = `<div class="chart-card"><h4>Services Running on This Host</h4>
                <div class="deps-list" id="host-services"><div class="empty-state">Loading...</div></div></div>`;
            await loadHostServices();
        }

        async function loadEntityDeps() {
            if (!currentEntityType || !currentEntityName) return;
            const body = document.getElementById('entity-modal-body');

            if (currentEntityType === 'service') {
                body.innerHTML = `<div class="chart-row">
                    <div class="chart-card"><h4>Upstream (What Calls This Service)</h4>
                        <div class="deps-list" id="upstream-deps"><div class="empty-state">Loading...</div></div></div>
                    <div class="chart-card"><h4>Downstream (What This Service Calls)</h4>
                        <div class="deps-list" id="downstream-deps"><div class="empty-state">Loading...</div></div></div>
                </div>`;
                await loadServiceDependencies();
            } else if (currentEntityType === 'database') {
                body.innerHTML = `<div class="chart-row">
                    <div class="chart-card"><h4>Host</h4>
                        <div class="deps-list" id="db-host-dep"><div class="empty-state">Loading...</div></div></div>
                    <div class="chart-card"><h4>Upstream (Services Using This Database)</h4>
                        <div class="deps-list" id="db-upstream-deps"><div class="empty-state">Loading...</div></div></div>
                </div><div class="chart-row">
                    <div class="chart-card"><h4>Downstream (Called by This Database's Spans)</h4>
                        <div class="deps-list" id="db-downstream-deps"><div class="empty-state">Loading...</div></div></div>
                </div>`;
                await loadDatabaseDependencies();
            }
        }

        async function loadEntityTopology() {
            if (!currentEntityType || !currentEntityName) return;
            const body = document.getElementById('entity-modal-body');
            const prefix = currentEntityType.charAt(0).toUpperCase() + currentEntityType.slice(1);
            body.innerHTML = `<div class="tab-controls">
                <span class="tab-title">${prefix} Topology</span>
                <select class="time-selector" id="entity-topology-depth" onchange="loadEntityTopology()">
                    <option value="1">1 Level</option><option value="2" selected>2 Levels</option>
                    <option value="3">3 Levels</option><option value="4">4 Levels</option>
                </select>
            </div>
            <div class="topology-container" id="entity-topology-graph" style="height: 450px; border: 1px solid var(--border-color); border-radius: 12px;"></div>`;

            const depth = document.getElementById('entity-topology-depth')?.value || '2';
            try {
                const response = await fetch(`/api/topology/${encodeURIComponent(currentEntityName)}?depth=${depth}`);
                const data = await response.json();
                renderTopologyGraph('entity-topology-graph', data);
            } catch (error) { console.error('Failed to load topology:', error); }
        }

        function buildTracesFilterBar() {
            return `<div class="tab-controls">
                <span class="tab-title">Recent Traces</span>
                <select class="time-selector" id="entity-traces-time" onchange="loadEntityTraces()">
                    <option value="1m">Last 1m</option><option value="5m" selected>Last 5m</option>
                    <option value="15m">Last 15m</option><option value="1h">Last 1h</option>
                </select>
            </div>
            <div class="filter-bar">
                <input type="text" id="entity-traces-search" placeholder="Search span name..." onkeydown="if(event.key==='Enter') loadEntityTraces()">
                <select id="entity-traces-status" onchange="loadEntityTraces()">
                    <option value="">All Status</option><option value="ERROR">ERROR</option><option value="OK">OK</option>
                </select>
                <input type="number" id="entity-traces-min-duration" placeholder="Min duration (ms)" onkeydown="if(event.key==='Enter') loadEntityTraces()">
                <select id="entity-traces-limit" onchange="loadEntityTraces()">
                    <option value="50" selected>50 rows</option><option value="100">100 rows</option>
                    <option value="250">250 rows</option><option value="500">500 rows</option><option value="1000">1000 rows</option>
                </select>
            </div>`;
        }

        async function loadEntityTraces() {
            if (!currentEntityType || !currentEntityName) return;
            const body = document.getElementById('entity-modal-body');

            // Build content if not present
            if (!document.getElementById('entity-traces-table')) {
                const showService = currentEntityType !== 'service';
                const headers = showService ?
                    '<th>Time</th><th>Service</th><th>Operation</th><th>Duration</th><th>Status</th><th>Trace ID</th>' :
                    '<th>Time</th><th>Operation</th><th>Kind</th><th>Duration</th><th>Status</th><th>Trace ID</th>';
                body.innerHTML = `${buildTracesFilterBar()}
                    <div class="data-table-container"><div class="data-table-wrapper">
                        <table class="data-table" id="entity-traces-table"><thead><tr>${headers}</tr></thead><tbody></tbody></table>
                    </div></div>`;
            }

            const timeWindow = document.getElementById('entity-traces-time')?.value || '5m';
            let filterParams = '';
            const searchVal = document.getElementById('entity-traces-search')?.value?.trim();
            const statusVal = document.getElementById('entity-traces-status')?.value;
            const minDurVal = document.getElementById('entity-traces-min-duration')?.value?.trim();
            if (searchVal) filterParams += `&search=${encodeURIComponent(searchVal)}`;
            if (statusVal) filterParams += `&status=${encodeURIComponent(statusVal)}`;
            if (minDurVal) filterParams += `&min_duration=${encodeURIComponent(minDurVal)}`;
            const limitVal = document.getElementById('entity-traces-limit')?.value || '50';

            try {
                const response = await fetch(`/api/entity/${currentEntityType}/${encodeURIComponent(currentEntityName)}/traces?time=${timeWindow}&limit=${limitVal}${filterParams}`);
                const data = await response.json();
                const tbody = document.getElementById('entity-traces-table').querySelector('tbody');
                const countBadge = document.getElementById('entity-traces-count');
                const showService = currentEntityType !== 'service';

                if (data.traces && data.traces.length > 0) {
                    if (countBadge) countBadge.textContent = data.traces.length;
                    tbody.innerHTML = data.traces.map(t => {
                        const time = (t.start_time || t.timestamp) ? new Date(t.start_time || t.timestamp).toLocaleTimeString() : '-';
                        const isError = t.status_code === 'ERROR';
                        if (showService) {
                            return `<tr class="${isError ? 'error-row' : ''}" onclick="openErrorModal('${t.trace_id}', '${t.span_id}')" style="cursor:pointer;">
                                <td>${time}</td><td title="${escapeHtml(t.service_name || '')}">${escapeHtml(t.service_name || '-')}</td>
                                <td title="${escapeHtml(t.span_name || '')}">${escapeHtml(t.span_name || '-')}</td>
                                <td>${t.duration_ms ? t.duration_ms + 'ms' : '-'}</td>
                                <td style="color:${isError?'var(--accent-error)':'var(--accent-success)'}">${t.status_code || 'OK'}</td>
                                <td title="${t.trace_id || ''}">${t.trace_id || '-'}</td></tr>`;
                        } else {
                            return `<tr class="${isError ? 'error-row' : ''}" onclick="openErrorModal('${t.trace_id}', '${t.span_id}')" style="cursor:pointer;">
                                <td>${time}</td><td title="${escapeHtml(t.span_name || '')}">${escapeHtml(t.span_name || '-')}</td>
                                <td>${t.span_kind || '-'}</td><td>${t.duration_ms}ms</td>
                                <td style="color:${isError?'var(--accent-error)':'var(--accent-success)'}">${t.status_code || 'OK'}</td>
                                <td title="${t.trace_id}">${t.trace_id || '-'}</td></tr>`;
                        }
                    }).join('');
                } else {
                    if (countBadge) countBadge.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No traces found</td></tr>';
                }
            } catch (error) { console.error('Failed to load traces:', error); }
        }

        function buildLogsFilterBar() {
            return `<div class="tab-controls">
                <span class="tab-title">Recent Logs</span>
                <select class="time-selector" id="entity-logs-time" onchange="loadEntityLogs()">
                    <option value="1m">Last 1m</option><option value="5m" selected>Last 5m</option>
                    <option value="15m">Last 15m</option><option value="1h">Last 1h</option>
                </select>
            </div>
            <div class="filter-bar">
                <input type="text" id="entity-logs-search" placeholder="Search log body..." onkeydown="if(event.key==='Enter') loadEntityLogs()">
                <select id="entity-logs-severity" onchange="loadEntityLogs()">
                    <option value="">All Severity</option><option value="ERROR">ERROR</option>
                    <option value="WARN">WARN</option><option value="INFO">INFO</option><option value="DEBUG">DEBUG</option>
                </select>
                <select id="entity-logs-limit" onchange="loadEntityLogs()">
                    <option value="50" selected>50 rows</option><option value="100">100 rows</option>
                    <option value="250">250 rows</option><option value="500">500 rows</option><option value="1000">1000 rows</option>
                </select>
            </div>`;
        }

        async function loadEntityLogs() {
            if (!currentEntityType || !currentEntityName) return;
            const body = document.getElementById('entity-modal-body');
            const showService = currentEntityType !== 'service';

            if (!document.getElementById('entity-logs-table')) {
                const headers = showService ?
                    '<th>Time</th><th>Service</th><th>Severity</th><th>Message</th><th>Trace ID</th>' :
                    '<th>Time</th><th>Severity</th><th>Message</th><th>Trace ID</th>';
                body.innerHTML = `${buildLogsFilterBar()}
                    <div class="data-table-container"><div class="data-table-wrapper">
                        <table class="data-table" id="entity-logs-table"><thead><tr>${headers}</tr></thead><tbody></tbody></table>
                    </div></div>`;
            }

            const timeWindow = document.getElementById('entity-logs-time')?.value || '5m';
            let filterParams = '';
            const searchVal = document.getElementById('entity-logs-search')?.value?.trim();
            const severityVal = document.getElementById('entity-logs-severity')?.value;
            if (searchVal) filterParams += `&search=${encodeURIComponent(searchVal)}`;
            if (severityVal) filterParams += `&severity=${encodeURIComponent(severityVal)}`;
            const limitVal = document.getElementById('entity-logs-limit')?.value || '50';

            try {
                const response = await fetch(`/api/entity/${currentEntityType}/${encodeURIComponent(currentEntityName)}/logs?time=${timeWindow}&limit=${limitVal}${filterParams}`);
                const data = await response.json();
                const tbody = document.getElementById('entity-logs-table').querySelector('tbody');
                const countBadge = document.getElementById('entity-logs-count');

                if (data.logs && data.logs.length > 0) {
                    if (countBadge) countBadge.textContent = data.logs.length;
                    tbody.innerHTML = data.logs.map(log => {
                        const time = log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '-';
                        const severity = (log.severity_text || 'INFO').toUpperCase();
                        const severityClass = severity === 'ERROR' ? 'severity-error' :
                                             severity === 'WARN' || severity === 'WARNING' ? 'severity-warn' :
                                             severity === 'DEBUG' ? 'severity-debug' : 'severity-info';
                        const isError = severity === 'ERROR';
                        if (showService) {
                            return `<tr class="${isError ? 'error-row' : ''}"><td>${time}</td>
                                <td title="${escapeHtml(log.service_name || '')}">${escapeHtml(log.service_name || '-')}</td>
                                <td class="${severityClass}">${severity}</td>
                                <td class="log-body" title="${escapeHtml(log.body || '')}">${escapeHtml(log.body || '-')}</td>
                                <td title="${log.trace_id || ''}">${log.trace_id || '-'}</td></tr>`;
                        } else {
                            return `<tr class="${isError ? 'error-row' : ''}"><td>${time}</td>
                                <td class="${severityClass}">${severity}</td>
                                <td class="log-body" title="${escapeHtml(log.body || '')}">${escapeHtml(log.body || '-')}</td>
                                <td title="${log.trace_id || ''}">${log.trace_id || '-'}</td></tr>`;
                        }
                    }).join('');
                } else {
                    if (countBadge) countBadge.textContent = '0';
                    const cols = showService ? 5 : 4;
                    tbody.innerHTML = `<tr><td colspan="${cols}" class="empty-state">No logs found</td></tr>`;
                }
            } catch (error) { console.error('Failed to load logs:', error); }
        }

        function buildMetricsFilterBar() {
            return `<div class="tab-controls">
                <span class="tab-title">Metrics</span>
                <select class="time-selector" id="entity-metrics-time" onchange="loadEntityMetrics()">
                    <option value="1m">Last 1m</option><option value="5m" selected>Last 5m</option>
                    <option value="15m">Last 15m</option><option value="1h">Last 1h</option>
                </select>
            </div>
            <div class="filter-bar">
                <input type="text" id="entity-metrics-search" placeholder="Search metric name..." onkeydown="if(event.key==='Enter') loadEntityMetrics()">
                <select id="entity-metrics-limit" onchange="loadEntityMetrics()">
                    <option value="50" selected>50 rows</option><option value="100">100 rows</option>
                    <option value="250">250 rows</option><option value="500">500 rows</option><option value="1000">1000 rows</option>
                </select>
            </div>`;
        }

        async function loadEntityMetrics() {
            if (!currentEntityType || !currentEntityName) return;
            const body = document.getElementById('entity-modal-body');

            if (!document.getElementById('entity-metrics-table')) {
                body.innerHTML = `${buildMetricsFilterBar()}
                    <div class="data-table-container"><div class="data-table-wrapper">
                        <table class="data-table" id="entity-metrics-table"><thead><tr>
                            <th>Metric Name</th><th>Data Points</th><th>Avg Value</th><th>Min</th><th>Max</th><th>Last Seen</th>
                        </tr></thead><tbody></tbody></table>
                    </div></div>`;
            }

            const timeWindow = document.getElementById('entity-metrics-time')?.value || '5m';
            let filterParams = '';
            const searchVal = document.getElementById('entity-metrics-search')?.value?.trim();
            if (searchVal) filterParams += `&search=${encodeURIComponent(searchVal)}`;
            const limitVal = document.getElementById('entity-metrics-limit')?.value || '50';

            try {
                const response = await fetch(`/api/entity/${currentEntityType}/${encodeURIComponent(currentEntityName)}/metrics?time=${timeWindow}&limit=${limitVal}${filterParams}`);
                const data = await response.json();
                const tbody = document.getElementById('entity-metrics-table').querySelector('tbody');
                const countBadge = document.getElementById('entity-metrics-count');

                if (data.metrics && data.metrics.length > 0) {
                    if (countBadge) countBadge.textContent = data.metrics.length;
                    tbody.innerHTML = data.metrics.map(m => {
                        const lastSeen = m.last_seen ? new Date(m.last_seen).toLocaleTimeString() : '-';
                        return `<tr><td title="${escapeHtml(m.metric_name)}">${escapeHtml(m.metric_name || '-')}</td>
                            <td>${m.data_points}</td><td>${m.avg_value !== null ? m.avg_value : '-'}</td>
                            <td>${m.min_value !== null ? m.min_value : '-'}</td><td>${m.max_value !== null ? m.max_value : '-'}</td>
                            <td>${lastSeen}</td></tr>`;
                    }).join('');
                } else {
                    if (countBadge) countBadge.textContent = '0';
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No metrics found</td></tr>';
                }
            } catch (error) { console.error('Failed to load metrics:', error); }
        }

        // =================================================================
        // Backward Compatibility Wrappers
        // =================================================================
        function openServiceModal(name) { openEntityModal('service', name); }
        function openDatabaseModal(name) { openEntityModal('database', name); }
        function openHostModal(name) { openEntityModal('host', name); }
        function closeModal() { closeEntityModal(); }
        function closeDatabaseModal() { closeEntityModal(); }
        function closeHostModal() { closeEntityModal(); }
        function switchModalTab(tab) { switchEntityTab(tab); }
        function switchDbModalTab(tab) { switchEntityTab(tab); }
        function switchHostModalTab(tab) { switchEntityTab(tab); }
        function switchService(name) { switchEntity(name); }
        function switchDatabase(name) { switchEntity(name); }
        function toggleModalAutoRefresh() { toggleEntityModalAutoRefresh(); }
        function toggleDbModalAutoRefresh() { toggleEntityModalAutoRefresh(); }
        function toggleHostModalAutoRefresh() { toggleEntityModalAutoRefresh(); }
        function startModalAutoRefresh() { startEntityModalAutoRefresh(); }
        function stopModalAutoRefresh() { stopEntityModalAutoRefresh(); }
        function startDbModalAutoRefresh() { startEntityModalAutoRefresh(); }
        function stopDbModalAutoRefresh() { stopEntityModalAutoRefresh(); }
        function startHostModalAutoRefresh() { startEntityModalAutoRefresh(); }
        function stopHostModalAutoRefresh() { stopEntityModalAutoRefresh(); }
        function refreshServiceModal() { refreshEntityModal(); }
        function refreshDatabaseModal() { refreshEntityModal(); }
        function refreshHostModal() { refreshEntityModal(); }

        function chartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { legend: { labels: { color: '#a0a0b0', font: { size: 11 } } } },
                scales: {
                    x: { ticks: { color: '#606070', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } },
                    y: { ticks: { color: '#606070', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' } }
                }
            };
        }

        // =================================================================
        // Sidebar Item Renderers
        // =================================================================
        function renderServiceItem(s, type, nameField) {
            const totalSpans = parseInt(s.total_spans) || 0;
            const errorPct = parseFloat(s.error_pct) || 0;
            let statusClass = 'status-healthy';
            let statusText = 'OK';
            if (totalSpans === 0) {
                statusClass = 'status-warning';
                statusText = 'no data';
            } else if (errorPct > 10) {
                statusClass = 'status-error';
                statusText = `${errorPct}% err`;
            } else if (errorPct > 1) {
                statusClass = 'status-warning';
                statusText = `${errorPct}% err`;
            }
            return `
                <div class="service-item" onclick="openEntityModal('service', '${escapeHtml(s[nameField])}')">
                    <span class="service-name">${escapeHtml(s[nameField])}</span>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
            `;
        }

        function renderDatabaseItem(db, type, nameField) {
            return `
                <div class="service-item" onclick="openEntityModal('database', '${escapeHtml(db[nameField])}')">
                    <span class="service-name">${escapeHtml(db[nameField])}</span>
                    <span class="status-badge status-healthy">${db.span_count || 0}</span>
                </div>
            `;
        }

        function renderHostItem(h, type, nameField) {
            const cpu = h.cpu_pct !== null ? h.cpu_pct : '-';
            const mem = h.memory_pct !== null ? h.memory_pct : '-';
            const disk = h.disk_pct !== null ? h.disk_pct : '-';
            const cpuClass = cpu === '-' ? '' : (cpu > 80 ? 'metric-error' : cpu > 60 ? 'metric-warn' : 'metric-ok');
            const memClass = mem === '-' ? '' : (mem > 85 ? 'metric-error' : mem > 70 ? 'metric-warn' : 'metric-ok');
            const diskClass = disk === '-' ? '' : (disk > 90 ? 'metric-error' : disk > 75 ? 'metric-warn' : 'metric-ok');
            return `
                <div class="host-item" onclick="openEntityModal('host', '${escapeHtml(h[nameField])}')" style="cursor: pointer;">
                    <div class="host-name">${escapeHtml(h[nameField])}</div>
                    <div class="host-metrics">
                        <div class="host-metric">
                            <div class="host-metric-value ${cpuClass}">${cpu}%</div>
                            <div class="host-metric-label">CPU</div>
                        </div>
                        <div class="host-metric">
                            <div class="host-metric-value ${memClass}">${mem}%</div>
                            <div class="host-metric-label">MEM</div>
                        </div>
                        <div class="host-metric">
                            <div class="host-metric-value ${diskClass}">${disk}%</div>
                            <div class="host-metric-label">DISK</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContainerItem(c, type, nameField) {
            const cpu = c.cpu_pct !== null && c.cpu_pct !== undefined ? c.cpu_pct : '-';
            const mem = c.memory_pct !== null && c.memory_pct !== undefined ? c.memory_pct : '-';
            const memMB = c.memory_usage_mb !== null && c.memory_usage_mb !== undefined ? c.memory_usage_mb : '-';
            const cpuClass = cpu === '-' ? '' : (cpu > 80 ? 'metric-error' : cpu > 60 ? 'metric-warn' : 'metric-ok');
            const memClass = mem === '-' ? '' : (mem > 85 ? 'metric-error' : mem > 70 ? 'metric-warn' : 'metric-ok');
            return `
                <div class="host-item" onclick="openEntityModal('container', '${escapeHtml(c[nameField])}')" style="cursor: pointer;">
                    <div class="host-name">${escapeHtml(c[nameField])}</div>
                    <div class="host-metrics">
                        <div class="host-metric">
                            <div class="host-metric-value ${cpuClass}">${cpu}%</div>
                            <div class="host-metric-label">CPU</div>
                        </div>
                        <div class="host-metric">
                            <div class="host-metric-value ${memClass}">${mem}%</div>
                            <div class="host-metric-label">MEM</div>
                        </div>
                        <div class="host-metric">
                            <div class="host-metric-value">${memMB} MB</div>
                            <div class="host-metric-label">MEM</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderGenericItem(entity, type, nameField) {
            return `
                <div class="service-item" onclick="openEntityModal('${type}', '${escapeHtml(entity[nameField])}')">
                    <span class="service-name">${escapeHtml(entity[nameField])}</span>
                </div>
            `;
        }

        function askAboutEntity(entityType, entityName) {
            if (!entityName) return;
            // Close all modals
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            stopModalAutoRefresh();
            // Pre-fill and focus chat input
            const input = document.getElementById('message-input');
            const prompts = {
                service: `Investigate the ${entityName} service. Check for recent errors, latency issues, and anomalies. Summarize its current health.`,
                database: `Investigate the ${entityName} database. Check for slow queries, error rates, and connection issues. Summarize its current health.`,
                host: `Investigate host ${entityName}. Check CPU, memory, disk usage and any services running on it with issues. Summarize its current health.`,
                container: `Investigate container ${entityName}. Check CPU and memory usage. Summarize its current health.`
            };
            input.value = prompts[entityType] || `Tell me about ${entityName}`;
            input.focus();
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        async function loadServiceDependencies() {
            if (!currentModalService) return;

            const upstreamDiv = document.getElementById('upstream-deps');
            const downstreamDiv = document.getElementById('downstream-deps');

            upstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';
            downstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/service/${encodeURIComponent(currentModalService)}/dependencies?time=15m`);
                const data = await response.json();

                // Render upstream (what calls this service)
                if (data.upstream && data.upstream.length > 0) {
                    upstreamDiv.innerHTML = data.upstream.map(dep => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(dep.dependent)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge ${dep.dep_type}">${dep.dep_type}</span>
                                ${escapeHtml(dep.dependent)}
                            </div>
                            <span class="dep-calls">${dep.call_count} calls</span>
                        </div>
                    `).join('');
                } else {
                    upstreamDiv.innerHTML = '<div class="empty-state">No upstream dependencies found</div>';
                }

                // Render downstream (what this service calls)
                if (data.downstream && data.downstream.length > 0) {
                    downstreamDiv.innerHTML = data.downstream.map(dep => `
                        <div class="dep-item" onclick="${dep.dep_type === 'database' ? `openDatabaseModal('${escapeHtml(dep.dependency)}')` : `openServiceModal('${escapeHtml(dep.dependency)}')`}">
                            <div class="dep-name">
                                <span class="dep-type-badge ${dep.dep_type}">${dep.dep_type}</span>
                                ${escapeHtml(dep.dependency)}
                            </div>
                            <span class="dep-calls">${dep.call_count} calls</span>
                        </div>
                    `).join('');
                } else {
                    downstreamDiv.innerHTML = '<div class="empty-state">No downstream dependencies found</div>';
                }
            } catch (error) {
                console.error('Failed to load dependencies:', error);
                upstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
                downstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
            }
        }

        // Database Modal Functions (kept for dependency loading)

        async function loadDatabaseDependencies() {
            if (!currentModalDatabase) return;

            const hostDiv = document.getElementById('db-host-dep');
            const upstreamDiv = document.getElementById('db-upstream-deps');
            const downstreamDiv = document.getElementById('db-downstream-deps');
            hostDiv.innerHTML = '<div class="empty-state">Loading...</div>';
            upstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';
            downstreamDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/database/${encodeURIComponent(currentModalDatabase)}/dependencies?time=15m`);
                const data = await response.json();

                // Host running this database
                if (data.host) {
                    hostDiv.innerHTML = `
                        <div class="dep-item" onclick="openHostModal('${escapeHtml(data.host)}')" style="cursor: pointer;">
                            <div class="dep-name">
                                <span class="dep-type-badge" style="background: rgba(16,185,129,0.15); color: #10b981;">host</span>
                                ${escapeHtml(data.host)}
                            </div>
                        </div>
                    `;
                } else {
                    hostDiv.innerHTML = '<div class="empty-state">No host information available</div>';
                }

                // Upstream (services that use this database)
                if (data.upstream && data.upstream.length > 0) {
                    upstreamDiv.innerHTML = data.upstream.map(dep => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(dep.dependent)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge service">service</span>
                                ${escapeHtml(dep.dependent)}
                            </div>
                            <div style="text-align: right;">
                                <span class="dep-calls">${dep.call_count} calls</span>
                                <span style="margin-left: 8px; color: ${dep.error_pct > 5 ? 'var(--accent-error)' : 'var(--text-muted)'}; font-size: 11px;">${dep.error_pct}% err</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    upstreamDiv.innerHTML = '<div class="empty-state">No services found using this database</div>';
                }

                // Downstream (what this database's spans call)
                if (data.downstream && data.downstream.length > 0) {
                    downstreamDiv.innerHTML = data.downstream.map(dep => {
                        const clickHandler = dep.dep_type === 'database'
                            ? `openDatabaseModal('${escapeHtml(dep.dependency)}')`
                            : `openServiceModal('${escapeHtml(dep.dependency)}')`;
                        return `
                        <div class="dep-item" onclick="${clickHandler}">
                            <div class="dep-name">
                                <span class="dep-type-badge ${dep.dep_type}">${dep.dep_type}</span>
                                ${escapeHtml(dep.dependency)}
                            </div>
                            <div style="text-align: right;">
                                <span class="dep-calls">${dep.call_count} calls</span>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    downstreamDiv.innerHTML = '<div class="empty-state">No downstream dependencies found</div>';
                }
            } catch (error) {
                console.error('Failed to load database dependencies:', error);
                hostDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
                upstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
                downstreamDiv.innerHTML = '<div class="empty-state">Error loading dependencies</div>';
            }
        }

        // Old database traces/logs/metrics functions removed - using generic entity functions now

        // Error Modal Functions
        async function openErrorModal(traceId, spanId) {
            document.getElementById('error-modal').classList.add('active');
            document.getElementById('error-modal-title').textContent = 'Loading...';

            // Reset badge
            const badge = document.getElementById('trace-detail-badge');
            badge.textContent = 'Trace';
            badge.style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';

            try {
                const response = await fetch(`/api/error/${encodeURIComponent(traceId)}/${encodeURIComponent(spanId)}`);
                const data = await response.json();

                if (data.error_info) {
                    const info = data.error_info;
                    const isError = info.status_code === 'ERROR';
                    document.getElementById('error-modal-title').textContent = info.span_name || 'Span Details';

                    // Update badge based on status
                    if (isError) {
                        badge.textContent = 'Error';
                        badge.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                    } else {
                        badge.textContent = 'Trace';
                        badge.style.background = 'linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%)';
                    }
                    document.getElementById('error-service').textContent = info.service_name || '-';
                    document.getElementById('error-operation').textContent = info.span_name || '-';
                    document.getElementById('error-timestamp').textContent = info.start_time ? new Date(info.start_time).toLocaleString() : '-';
                    document.getElementById('error-duration').textContent = info.duration_ms ? `${info.duration_ms}ms` : '-';
                    document.getElementById('error-trace-id').textContent = traceId;
                }

                // Exception details
                const exceptionCard = document.getElementById('exception-card');
                if (data.exception && data.exception.exception_type) {
                    exceptionCard.style.display = 'block';
                    document.getElementById('exception-type').textContent = data.exception.exception_type || '-';
                    document.getElementById('exception-message').textContent = data.exception.exception_message || '-';
                } else {
                    exceptionCard.style.display = 'none';
                }

                // Full trace
                const traceTable = document.getElementById('trace-table').querySelector('tbody');
                if (data.trace && data.trace.length > 0) {
                    traceTable.innerHTML = data.trace.map(span => `
                        <tr class="${span.status_code === 'ERROR' ? 'error-row' : ''}">
                            <td>${escapeHtml(span.service_name)}</td>
                            <td title="${escapeHtml(span.span_name)}">${escapeHtml(span.span_name)}</td>
                            <td>${span.duration_ms}ms</td>
                            <td style="color: ${span.status_code === 'ERROR' ? 'var(--accent-error)' : 'var(--accent-success)'}">${span.status_code || 'OK'}</td>
                        </tr>
                    `).join('');
                } else {
                    traceTable.innerHTML = '<tr><td colspan="4" class="empty-state">No trace data</td></tr>';
                }

            } catch (error) {
                console.error('Failed to load error details:', error);
                document.getElementById('error-modal-title').textContent = 'Error loading details';
            }
        }

        function closeErrorModal() {
            document.getElementById('error-modal').classList.remove('active');
        }

        // Host data loading functions (used by generic entity loaders)
        async function loadHostData(hostName) {
            try {
                const response = await fetch(`/api/host/${encodeURIComponent(hostName)}/services`);
                const data = await response.json();

                // Update current metrics display
                const metricsDiv = document.getElementById('host-current-metrics');
                if (data.current_metrics) {
                    const m = data.current_metrics;
                    const cpu = m.cpu_pct !== null ? m.cpu_pct : '-';
                    const mem = m.memory_pct !== null ? m.memory_pct : '-';
                    const disk = m.disk_pct !== null ? m.disk_pct : '-';

                    const cpuClass = cpu === '-' ? '' : (cpu > 80 ? 'metric-error' : cpu > 60 ? 'metric-warn' : 'metric-ok');
                    const memClass = mem === '-' ? '' : (mem > 85 ? 'metric-error' : mem > 70 ? 'metric-warn' : 'metric-ok');
                    const diskClass = disk === '-' ? '' : (disk > 90 ? 'metric-error' : disk > 75 ? 'metric-warn' : 'metric-ok');

                    metricsDiv.innerHTML = `
                        <div class="host-metric-card">
                            <div class="value ${cpuClass}">${cpu}%</div>
                            <div class="label">CPU Utilization</div>
                        </div>
                        <div class="host-metric-card">
                            <div class="value ${memClass}">${mem}%</div>
                            <div class="label">Memory Utilization</div>
                        </div>
                        <div class="host-metric-card">
                            <div class="value ${diskClass}">${disk}%</div>
                            <div class="label">Disk Utilization</div>
                        </div>
                    `;
                } else {
                    metricsDiv.innerHTML = '<div class="empty-state">No metrics available</div>';
                }

                // Update host info
                const infoDiv = document.getElementById('host-info');
                if (data.host_info) {
                    const info = data.host_info;
                    infoDiv.innerHTML = `
                        <div class="host-info-row">
                            <span class="host-info-label">Hostname</span>
                            <span class="host-info-value">${escapeHtml(hostName)}</span>
                        </div>
                        <div class="host-info-row">
                            <span class="host-info-label">OS Type</span>
                            <span class="host-info-value">${escapeHtml(info.os_type || 'Unknown')}</span>
                        </div>
                        <div class="host-info-row">
                            <span class="host-info-label">Last Seen</span>
                            <span class="host-info-value">${info.last_seen ? new Date(info.last_seen).toLocaleString() : '-'}</span>
                        </div>
                    `;
                } else {
                    infoDiv.innerHTML = `
                        <div class="host-info-row">
                            <span class="host-info-label">Hostname</span>
                            <span class="host-info-value">${escapeHtml(hostName)}</span>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Failed to load host data:', error);
            }
        }

        async function loadHostServices() {
            if (!currentModalHost) return;

            const servicesDiv = document.getElementById('host-services');
            servicesDiv.innerHTML = '<div class="empty-state">Loading...</div>';

            try {
                const response = await fetch(`/api/host/${encodeURIComponent(currentModalHost)}/services`);
                const data = await response.json();

                if (data.services && data.services.length > 0) {
                    servicesDiv.innerHTML = data.services.map(svc => `
                        <div class="dep-item" onclick="openServiceModal('${escapeHtml(svc.service_name)}')">
                            <div class="dep-name">
                                <span class="dep-type-badge service">service</span>
                                ${escapeHtml(svc.service_name)}
                            </div>
                            <div style="text-align: right;">
                                <span class="dep-calls">${svc.span_count} spans</span>
                                <span style="margin-left: 8px; color: ${svc.error_pct > 5 ? 'var(--accent-error)' : 'var(--text-muted)'}; font-size: 11px;">${svc.error_pct}% err</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    servicesDiv.innerHTML = '<div class="empty-state">No services found on this host</div>';
                }
            } catch (error) {
                console.error('Failed to load host services:', error);
                servicesDiv.innerHTML = '<div class="empty-state">Error loading services</div>';
            }
        }

        // Old host tab/traces/logs/metrics functions removed - using generic entity functions now

        // Topology Graph Rendering
        let topologyNetworks = {};

        function renderTopologyGraph(containerId, data) {
            // Destroy existing network
            if (topologyNetworks[containerId]) {
                topologyNetworks[containerId].destroy();
                delete topologyNetworks[containerId];
            }

            const container = document.getElementById(containerId);
            if (!container) return;

            if (!data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 40px;">No topology data found</div>';
                return;
            }

            const nodeColors = {
                application: { background: '#7c3aed', border: '#6d28d9', highlight: { background: '#8b5cf6', border: '#7c3aed' } },
                database: { background: '#f59e0b', border: '#d97706', highlight: { background: '#fbbf24', border: '#f59e0b' } },
                infrastructure: { background: '#06b6d4', border: '#0891b2', highlight: { background: '#22d3ee', border: '#06b6d4' } },
                host: { background: '#06b6d4', border: '#0891b2', highlight: { background: '#22d3ee', border: '#06b6d4' } }
            };

            const nodeShapes = {
                application: 'dot',
                database: 'diamond',
                infrastructure: 'square',
                host: 'square'
            };

            const nodes = new vis.DataSet(data.nodes.map(n => {
                const type = n.type || 'application';
                const colors = nodeColors[type] || nodeColors.application;
                const isRoot = n.root || false;
                const errorPct = n.error_pct || 0;
                let borderColor = colors.border;
                if (errorPct > 5) borderColor = '#ef4444';
                else if (errorPct > 1) borderColor = '#f59e0b';

                return {
                    id: n.id,
                    label: n.label,
                    shape: nodeShapes[type] || 'dot',
                    size: isRoot ? 30 : 20,
                    color: {
                        background: colors.background,
                        border: borderColor,
                        highlight: colors.highlight
                    },
                    borderWidth: isRoot ? 3 : 2,
                    font: { color: '#f0f0f5', size: 12, face: 'Inter' },
                    title: buildNodeTooltip(n)
                };
            }));

            const edges = new vis.DataSet(data.edges.map((e, i) => {
                const errorPct = e.error_pct || 0;
                let edgeColor = 'rgba(160, 160, 176, 0.5)';
                if (errorPct > 5) edgeColor = 'rgba(239, 68, 68, 0.7)';
                else if (errorPct > 1) edgeColor = 'rgba(245, 158, 11, 0.7)';

                return {
                    id: i,
                    from: e.from,
                    to: e.to,
                    label: e.label || '',
                    arrows: e.label === 'hosts' ? '' : 'to',
                    color: { color: edgeColor, highlight: '#00d9ff' },
                    font: { color: '#a0a0b0', size: 10, face: 'Inter', strokeWidth: 0 },
                    width: Math.max(1, Math.min(4, Math.log10((e.call_count || 1) + 1))),
                    smooth: { type: 'curvedCW', roundness: 0.15 }
                };
            }));

            const options = {
                physics: {
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: { gravitationalConstant: -80, centralGravity: 0.01, springLength: 150, springConstant: 0.04 },
                    stabilization: { iterations: 150 }
                },
                interaction: { hover: true, tooltipDelay: 200 },
                layout: { improvedLayout: true }
            };

            topologyNetworks[containerId] = new vis.Network(container, { nodes, edges }, options);

            // Click to navigate
            topologyNetworks[containerId].on('doubleClick', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const node = data.nodes.find(n => n.id === nodeId);
                    if (node && !node.root) {
                        if (node.type === 'database') {
                            openDatabaseModal(nodeId);
                        } else if (node.type === 'host') {
                            openHostModal(nodeId);
                        } else {
                            openServiceModal(nodeId);
                        }
                    }
                }
            });
        }

        function buildNodeTooltip(n) {
            let tip = `<b>${n.label}</b><br>Type: ${n.type || 'application'}`;
            if (n.span_count != null) tip += `<br>Spans: ${n.span_count}`;
            if (n.error_pct != null) tip += `<br>Error: ${n.error_pct}%`;
            if (n.avg_latency_ms != null) tip += `<br>Avg Latency: ${n.avg_latency_ms}ms`;
            if (n.cpu_pct != null) tip += `<br>CPU: ${n.cpu_pct}%`;
            if (n.memory_pct != null) tip += `<br>Memory: ${n.memory_pct}%`;
            return tip;
        }

        // Old topology functions kept as wrappers for backward compat
        async function loadServiceTopology() { await loadEntityTopology(); }
        async function loadDatabaseTopology() { await loadEntityTopology(); }
        async function loadHostTopology() { await loadEntityTopology(); }

        // Old host auto-refresh/close functions removed - using generic entity functions now

        // Help Modal Functions
        function openHelpModal() {
            document.getElementById('help-modal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('help-modal').classList.remove('active');
        }

        // =====================================================================
        // Predictions
        // =====================================================================

        // Predictions are now fetched as part of refreshAlerts() above

        // =====================================================================
        // Incident Context in Alert Modal
        // =====================================================================

        async function loadIncidentContext(alertId) {
            try {
                const response = await fetch(`/api/incidents/context/${encodeURIComponent(alertId)}`);
                const data = await response.json();

                const container = document.getElementById('incident-context-body');
                if (!container) return;

                if (!data.context) {
                    container.innerHTML = '<div class="empty-state" style="font-size:11px;">No incident context captured for this alert.</div>';
                    return;
                }

                const ctx = data.context;
                let html = '';

                // Metrics table
                if (ctx.metrics_snapshot && Array.isArray(ctx.metrics_snapshot) && ctx.metrics_snapshot.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;margin-bottom:4px;">Metrics at Incident Time</div>';
                    html += '<table class="context-metric-table"><thead><tr><th>Metric</th><th>Avg</th><th>Min</th><th>Max</th><th>Points</th></tr></thead><tbody>';
                    ctx.metrics_snapshot.slice(0, 15).forEach(m => {
                        html += `<tr><td>${escapeHtml(m.metric || '')}</td><td>${m.avg}</td><td>${m.min}</td><td>${m.max}</td><td>${m.data_points}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }

                // Error traces
                if (ctx.error_traces && Array.isArray(ctx.error_traces) && ctx.error_traces.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;margin:8px 0 4px;">Error Traces</div>';
                    html += '<div class="context-traces-list">';
                    ctx.error_traces.slice(0, 10).forEach(t => {
                        html += `<div class="context-trace-item"><code>${escapeHtml(t.span_name || '')}</code> &mdash; ${t.duration_ms}ms <span style="color:var(--text-muted)">(${t.trace_id ? t.trace_id.substring(0, 8) : ''})</span></div>`;
                    });
                    html += '</div>';
                }

                // Logs
                if (ctx.log_snapshot && Array.isArray(ctx.log_snapshot) && ctx.log_snapshot.length > 0) {
                    html += '<div style="font-size:12px;font-weight:600;margin:8px 0 4px;">Related Logs</div>';
                    html += '<div class="context-logs-list">';
                    ctx.log_snapshot.slice(0, 15).forEach(l => {
                        const sevClass = (l.severity || '').toLowerCase() === 'error' ? 'color:var(--accent-error)' : 'color:var(--accent-warning)';
                        html += `<div class="context-log-item"><span style="${sevClass};font-weight:600">${escapeHtml(l.severity || '')}</span> ${escapeHtml((l.message || '').substring(0, 200))}</div>`;
                    });
                    html += '</div>';
                }

                // Pattern info
                if (data.pattern) {
                    const pat = data.pattern;
                    html += `<div class="pattern-info">
                        <strong>Recurring Pattern:</strong> This pattern has occurred <strong>${pat.occurrence_count}</strong> time(s).
                        ${pat.avg_duration_minutes ? ` Avg duration: ${pat.avg_duration_minutes.toFixed(1)} min.` : ''}
                        ${pat.common_root_cause ? `<br>Common root cause: ${escapeHtml(pat.common_root_cause)}` : ''}
                    </div>`;
                }

                container.innerHTML = html || '<div class="empty-state" style="font-size:11px;">No context data available.</div>';

            } catch (error) {
                console.error('Failed to load incident context:', error);
                const container = document.getElementById('incident-context-body');
                if (container) container.innerHTML = '<div class="empty-state" style="font-size:11px;">Failed to load context.</div>';
            }
        }

        // Modify openAlertModal to include incident context section
        const _originalOpenAlertModal = openAlertModal;
        openAlertModal = function(alert, alertId) {
            _originalOpenAlertModal(alert, alertId);

            // After the original modal renders, append the incident context section
            if (alert) {
                const content = document.getElementById('alert-modal-content');
                if (content) {
                    const actionsDiv = content.querySelector('.alert-actions');
                    if (actionsDiv) {
                        const contextSection = document.createElement('div');
                        contextSection.className = 'incident-context-section';
                        contextSection.innerHTML = `
                            <div class="context-toggle" onclick="toggleIncidentContext(this)">
                                <span class="arrow">\u25B6</span> Incident Context
                            </div>
                            <div class="context-body" id="incident-context-body">
                                <div class="empty-state" style="font-size:11px;">Loading context...</div>
                            </div>
                        `;
                        content.insertBefore(contextSection, actionsDiv);
                    }
                }
            }
        };

        function toggleIncidentContext(el) {
            el.classList.toggle('open');
            const body = el.nextElementSibling;
            body.classList.toggle('open');

            // Load context on first open
            if (body.classList.contains('open') && body.innerHTML.includes('Loading context')) {
                const alertModal = document.getElementById('alert-modal-content');
                const alertIdEl = alertModal ? alertModal.querySelector('.alert-meta-value') : null;
                const alertId = alertIdEl ? alertIdEl.textContent.trim() : '';
                if (alertId) loadIncidentContext(alertId);
            }
        }

        // =====================================================================
        // Simulation Control
        // =====================================================================

        let simScenarios = [];
        let simPollInterval = null;
        let lastSimRunId = null;

        async function initSimulator() {
            try {
                const response = await fetch('/api/simulation/scenarios');
                const data = await response.json();
                simScenarios = data.scenarios || [];

                const select = document.getElementById('sim-scenario-select');
                select.innerHTML = '<option value="">Select scenario...</option>' +
                    simScenarios.map(s => `<option value="${s.id}" title="${escapeHtml(s.description)}">${escapeHtml(s.name)} (${s.duration_minutes}min)</option>`).join('');

                // Check if a simulation is already running
                await refreshSimulationStatus();
            } catch (error) {
                console.error('Failed to init simulator:', error);
            }
        }

        function updateScenarioDescription() {
            const select = document.getElementById('sim-scenario-select');
            const startBtn = document.getElementById('sim-start-btn');
            startBtn.disabled = !select.value;
            updateUndoButton();
        }

        function updateUndoButton() {
            const select = document.getElementById('sim-scenario-select');
            const undoBtn = document.getElementById('sim-undo-btn');
            const stopBtn = document.getElementById('sim-stop-btn');
            const isRunning = stopBtn.style.display !== 'none';
            undoBtn.disabled = !select.value || isRunning;
        }

        async function undoScenario() {
            const select = document.getElementById('sim-scenario-select');
            const scenarioId = select.value;
            if (!scenarioId) return;

            const undoBtn = document.getElementById('sim-undo-btn');
            undoBtn.disabled = true;
            undoBtn.innerHTML = 'Undoing...';

            try {
                const response = await fetch('/api/simulation/cleanup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario: scenarioId })
                });
                const data = await response.json();

                if (data.success) {
                    undoBtn.innerHTML = 'Done &#10003;';
                    setTimeout(() => { undoBtn.innerHTML = '&#8617; Undo'; updateUndoButton(); }, 2000);
                } else {
                    undoBtn.innerHTML = data.error || 'Failed';
                    setTimeout(() => { undoBtn.innerHTML = '&#8617; Undo'; updateUndoButton(); }, 3000);
                }
            } catch (error) {
                console.error('Failed to undo scenario:', error);
                undoBtn.innerHTML = 'Error';
                setTimeout(() => { undoBtn.innerHTML = '&#8617; Undo'; updateUndoButton(); }, 3000);
            }
        }

        async function startSimulation() {
            const select = document.getElementById('sim-scenario-select');
            const scenarioId = select.value;
            if (!scenarioId) return;

            const startBtn = document.getElementById('sim-start-btn');
            startBtn.disabled = true;
            startBtn.innerHTML = 'Starting...';

            try {
                const response = await fetch('/api/simulation/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scenario: scenarioId })
                });
                const data = await response.json();

                if (data.success) {
                    lastSimRunId = data.run_id;
                    startBtn.style.display = 'none';
                    document.getElementById('sim-stop-btn').style.display = 'inline-block';
                    document.getElementById('sim-header-progress').style.display = 'flex';

                    // Start polling
                    simPollInterval = setInterval(pollSimulationStatus, 5000);
                    pollSimulationStatus();
                } else {
                    startBtn.innerHTML = data.error || 'Failed';
                    setTimeout(() => { startBtn.innerHTML = '&#9654; Start'; startBtn.disabled = false; }, 3000);
                }
            } catch (error) {
                console.error('Failed to start simulation:', error);
                startBtn.innerHTML = 'Error';
                setTimeout(() => { startBtn.innerHTML = '&#9654; Start'; startBtn.disabled = false; }, 3000);
            }
        }

        async function stopSimulation() {
            try {
                await fetch('/api/simulation/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ run_id: lastSimRunId })
                });
            } catch (error) {
                console.error('Failed to stop simulation:', error);
            }
            await refreshSimulationStatus();
        }

        async function pollSimulationStatus() {
            await refreshSimulationStatus();
        }

        async function refreshSimulationStatus() {
            try {
                const response = await fetch('/api/simulation/status');
                const data = await response.json();
                const status = data.status;

                const startBtn = document.getElementById('sim-start-btn');
                const stopBtn = document.getElementById('sim-stop-btn');
                const progressDiv = document.getElementById('sim-header-progress');
                const elapsed = document.getElementById('sim-elapsed');
                const progressFill = document.getElementById('sim-progress-fill');
                const stepDiv = document.getElementById('sim-header-step');

                if (!status) {
                    // Idle state
                    startBtn.style.display = 'inline-block';
                    startBtn.innerHTML = '&#9654; Start';
                    startBtn.disabled = !document.getElementById('sim-scenario-select').value;
                    stopBtn.style.display = 'none';
                    progressDiv.style.display = 'none';
                    stepDiv.style.display = 'none';
                    updateUndoButton();
                    return;
                }

                // Update elapsed time
                if (status.elapsed_seconds != null) {
                    const mins = Math.floor(status.elapsed_seconds / 60);
                    const secs = status.elapsed_seconds % 60;
                    elapsed.textContent = `${mins}m ${secs}s`;
                }

                progressFill.style.width = (status.progress_pct || 0) + '%';

                // Show latest step label
                if (status.steps_completed && status.steps_completed.length > 0) {
                    const latest = status.steps_completed[status.steps_completed.length - 1];
                    const total = status.total_steps || status.steps_completed.length;
                    stepDiv.textContent = `Step ${status.steps_completed.length}/${total}: ${latest.label}`;
                    stepDiv.style.display = 'block';
                }

                if (status.status === 'running') {
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    progressDiv.style.display = 'flex';
                    updateUndoButton();

                    // Ensure polling is active (e.g. after page refresh)
                    if (!simPollInterval) {
                        lastSimRunId = status.run_id;
                        simPollInterval = setInterval(pollSimulationStatus, 5000);
                    }
                } else {
                    // Completed or aborted
                    startBtn.style.display = 'inline-block';
                    startBtn.innerHTML = '&#9654; Start';
                    startBtn.disabled = !document.getElementById('sim-scenario-select').value;
                    stopBtn.style.display = 'none';
                    updateUndoButton();

                    if (simPollInterval) {
                        clearInterval(simPollInterval);
                        simPollInterval = null;
                    }

                    // Show results as a chat message
                    if (status.run_id) {
                        showSimulationResults(status.run_id);
                    }
                }
            } catch (error) {
                console.error('Failed to get simulation status:', error);
            }
        }

        async function showSimulationResults(runId) {
            try {
                const response = await fetch(`/api/simulation/results/${encodeURIComponent(runId)}`);
                const data = await response.json();

                if (!data.success) return;

                const results = data.results;
                let summary = '**Simulation Complete**\n\n';

                // Alerts that fired
                const firedAlerts = results.fired_alerts || [];
                summary += `**Alerts Fired:** ${firedAlerts.length}\n`;
                if (firedAlerts.length > 0) {
                    firedAlerts.forEach(a => {
                        const t = a.created_at ? new Date(a.created_at).toLocaleTimeString() : '';
                        summary += `- ${t} | ${a.service_name || ''} | ${a.alert_type || ''} | ${a.severity || ''}\n`;
                    });
                }

                // Predictions generated
                const firedPredictions = results.fired_predictions || [];
                summary += `\n**Predictions Generated:** ${firedPredictions.length}\n`;
                if (firedPredictions.length > 0) {
                    firedPredictions.forEach(p => {
                        summary += `- ${p.host_name || ''} | ${p.resource_type || ''} | ${p.hours_until_exhaustion ? p.hours_until_exhaustion.toFixed(1) + 'h left' : '?'} | ${p.confidence || ''}\n`;
                    });
                }

                addMessage('assistant', summary);

                // Reset progress display after showing results
                document.getElementById('sim-header-progress').style.display = 'none';
                document.getElementById('sim-header-step').style.display = 'none';
                document.getElementById('sim-progress-fill').style.width = '0%';
                document.getElementById('sim-elapsed').textContent = '';

            } catch (error) {
                console.error('Failed to load simulation results:', error);
            }
        }

        document.getElementById('entity-modal').addEventListener('click', function(e) {
            if (e.target === this) closeEntityModal();
        });

        document.getElementById('error-modal').addEventListener('click', function(e) {
            if (e.target === this) closeErrorModal();
        });

        document.getElementById('help-modal').addEventListener('click', function(e) {
            if (e.target === this) closeHelpModal();
        });

        document.getElementById('alert-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAlertModal();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeEntityModal();
                closeErrorModal();
                closeHelpModal();
                closeAlertModal();
            }
        });
    </script>
</body>
</html>
